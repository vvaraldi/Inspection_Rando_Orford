rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // PUBLIC ACCESS - For status page
    // Allow anyone to read trails, shelters, and recent inspections
    match /trails/{document} {
      allow read: if true;  // Public read access
      allow write: if request.auth != null && 
                   get(/databases/$(database)/documents/inspectors/$(request.auth.uid)).data.role == 'admin';
    }
    
    match /shelters/{document} {
      allow read: if true;  // Public read access
      allow write: if request.auth != null && 
                   get(/databases/$(database)/documents/inspectors/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Allow public read of inspections (for status page)
    match /inspections/{document} {
      allow read: if true;  // Public read access
      allow create, update: if request.auth != null;
      allow delete: if request.auth != null &&
                   get(/databases/$(database)/documents/inspectors/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Legacy collections (if they exist)
    match /trail_inspections/{document} {
      allow read: if true;  // Public read access
      allow create, update: if request.auth != null;
      allow delete: if request.auth != null &&
                   get(/databases/$(database)/documents/inspectors/$(request.auth.uid)).data.role == 'admin';
    }
    
    match /shelter_inspections/{document} {
      allow read: if true;  // Public read access
      allow create, update: if request.auth != null;
      allow delete: if request.auth != null &&
                   get(/databases/$(database)/documents/inspectors/$(request.auth.uid)).data.role == 'admin';
    }
    
    // PROTECTED ACCESS - Requires authentication
    // Inspector profiles - only authenticated users can read
    match /inspectors/{userId} {
      allow read: if request.auth != null;
      // Write only by the owner or admins
      allow write: if request.auth != null && 
                   (request.auth.uid == userId || 
                    get(/databases/$(database)/documents/inspectors/$(request.auth.uid)).data.role == 'admin');
    }
    
    // System configuration - admin only
    match /config/{document} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                   get(/databases/$(database)/documents/inspectors/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Locations data - authenticated users only
    match /locations/{document} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                   get(/databases/$(database)/documents/inspectors/$(request.auth.uid)).data.role == 'admin';
    }
  }
}

service firebase.storage {
  match /b/{bucket}/o {
    // Public read access for all images
    match /{allPaths=**} {
      allow read: if true;  // Anyone can view uploaded photos
      // Only authenticated users can upload
      allow write: if request.auth != null;
      // Only admins or the uploader can delete
      allow delete: if request.auth != null && 
                    (request.auth.uid == resource.metadata.uploadedBy ||
                     firestore.get(/databases/(default)/documents/inspectors/$(request.auth.uid)).data.role == 'admin');
    }
  }
}