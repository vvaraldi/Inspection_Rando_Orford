<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mont Orford - √âtat des sentiers</title>
  <link rel="stylesheet" href="../css/styles.css">
  
  <style>
    /* Styles sp√©cifiques pour la page publique */
    .public-header {
      background: linear-gradient(135deg, #1b4b72 0%, #2c7a5d 100%);
      color: white;
      padding: 2rem 1rem;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .public-header::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #43a047, #2196f3, #f44336, #212121);
    }
    
    .public-header h1 {
      color: white;
      margin: 0;
      font-size: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .public-header .subtitle {
      margin-top: 0.5rem;
      opacity: 0.9;
      font-size: 1.1rem;
    }
    
    .last-update-public {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      display: inline-block;
      font-size: 0.9rem;
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      padding: 2rem 1rem;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .status-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      border-top: 4px solid #1b4b72;
    }
    
    .status-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }
    
    .status-card.critical {
      border-top-color: #c53030;
    }
    
    .status-card.warning {
      border-top-color: #dd6b20;
    }
    
    .status-card.good {
      border-top-color: #2c7a5d;
    }
    
    .trail-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }
    
    .trail-name {
      font-size: 1.2rem;
      font-weight: 600;
      color: #1f2937;
      margin: 0;
    }
    
    .trail-type {
      font-size: 0.85rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }
    
    .status-indicator {
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .status-good {
      background: rgba(44, 122, 93, 0.15);
      color: #2c7a5d;
    }
    
    .status-warning {
      background: rgba(221, 107, 32, 0.15);
      color: #dd6b20;
    }
    
    .status-critical {
      background: rgba(197, 48, 48, 0.15);
      color: #c53030;
    }
    
    .status-not-inspected {
      background: rgba(160, 174, 192, 0.2);
      color: #4a5568;
    }
    
    .trail-details {
      border-top: 1px solid #e5e7eb;
      padding-top: 1rem;
      margin-top: 1rem;
    }
    
    .detail-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    
    .detail-label {
      color: #6b7280;
    }
    
    .detail-value {
      color: #1f2937;
      font-weight: 500;
    }
    
    .issues-section {
      margin-top: 1rem;
      padding: 0.75rem;
      background: #fef3c7;
      border-radius: 8px;
      border-left: 4px solid #f59e0b;
    }
    
    .issues-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #92400e;
      margin-bottom: 0.5rem;
    }
    
    .issue-item {
      font-size: 0.85rem;
      color: #78350f;
      margin-left: 1rem;
      margin-bottom: 0.25rem;
    }
    
    .legend-public {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin: 2rem auto;
      max-width: 800px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .legend-public h3 {
      margin-top: 0;
      color: #1f2937;
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }
    
    .legend-items {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      justify-content: center;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    
    .filters-public {
      background: white;
      padding: 1.5rem;
      margin: 2rem auto;
      max-width: 1400px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .filter-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: center;
    }
    
    .filter-btn {
      padding: 0.5rem 1rem;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }
    
    .filter-btn:hover {
      border-color: #1b4b72;
      background: #f8f9fb;
    }
    
    .filter-btn.active {
      background: #1b4b72;
      color: white;
      border-color: #1b4b72;
    }
    
    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      padding: 1.5rem;
      background: white;
      border-radius: 12px;
      margin: 2rem auto;
      max-width: 1400px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .stat-card {
      text-align: center;
      padding: 1rem;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #1b4b72;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }
    
    .no-results {
      text-align: center;
      padding: 3rem;
      color: #6b7280;
      font-size: 1.1rem;
    }
    
    .difficulty-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }
    
    .difficulty-easy {
      background: #43a047;
      color: white;
    }
    
    .difficulty-medium {
      background: #2196f3;
      color: white;
    }
    
    .difficulty-hard {
      background: #212121;
      color: white;
    }
    
    @media (max-width: 768px) {
      .public-header h1 {
        font-size: 1.5rem;
      }
      
      .status-grid {
        grid-template-columns: 1fr;
        padding: 1rem;
      }
      
      .stats-summary {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>

<body>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèîÔ∏è</text></svg>">
  
  <div class="public-header">
    <h1>üèîÔ∏è Mont Orford - √âtat des sentiers</h1>
    <div class="subtitle">Conditions actuelles des sentiers et abris</div>
    <div class="last-update-public">
      Derni√®re mise √† jour: <span id="last-update-time">--:--</span>
    </div>
  </div>
  
  <!-- R√©sum√© des statistiques -->
  <div class="stats-summary">
    <div class="stat-card">
      <div class="stat-value" id="total-trails">0</div>
      <div class="stat-label">Sentiers</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="total-shelters">0</div>
      <div class="stat-label">Abris</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="good-count">0</div>
      <div class="stat-label">En bon √©tat</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="warning-count">0</div>
      <div class="stat-label">Attention requise</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="critical-count">0</div>
      <div class="stat-label">√âtat critique</div>
    </div>
  </div>
  
  <!-- Filtres -->
  <div class="filters-public">
    <div class="filter-buttons">
      <button class="filter-btn active" data-filter="all">Tout afficher</button>
      <button class="filter-btn" data-filter="trails">Sentiers uniquement</button>
      <button class="filter-btn" data-filter="shelters">Abris uniquement</button>
      <button class="filter-btn" data-filter="good">Bon √©tat</button>
      <button class="filter-btn" data-filter="warning">Attention</button>
      <button class="filter-btn" data-filter="critical">Critique</button>
      <button class="filter-btn" data-filter="issues">Avec probl√®mes</button>
    </div>
  </div>
  
  <!-- L√©gende -->
  <div class="legend-public">
    <h3>L√©gende des √©tats</h3>
    <div class="legend-items">
      <div class="legend-item">
        <div class="legend-dot" style="background: #2c7a5d;"></div>
        <span>Bon √©tat - Aucun probl√®me</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background: #dd6b20;"></div>
        <span>Attention - Probl√®mes mineurs</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background: #c53030;"></div>
        <span>Critique - Intervention urgente</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background: #a0aec0;"></div>
        <span>Non inspect√© r√©cemment</span>
      </div>
    </div>
  </div>
  
  <!-- Grille des statuts -->
  <div class="status-grid" id="status-grid">
    <div class="no-results">Chargement des donn√©es...</div>
  </div>
  
  <!-- Scripts Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  
  <script>
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDcBZrwGTskM7QUvanzLTACEJ_T-55j-DA",
      authDomain: "trail-inspection.firebaseapp.com",
      projectId: "trail-inspection",
      storageBucket: "trail-inspection.firebasestorage.app",
      messagingSenderId: "415995272058",
      appId: "1:415995272058:web:dc476de8ffee052e2ad4c3",
      measurementId: "G-EBLYWBM9YB"
    };
    
    // Initialisation de Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // Variables globales
    let allData = [];
    let currentFilter = 'all';
    
    // Chargement des donn√©es au d√©marrage
    document.addEventListener('DOMContentLoaded', function() {
      loadPublicData();
      setupFilters();
      
      // Actualisation automatique toutes les 5 minutes
      setInterval(loadPublicData, 5 * 60 * 1000);
    });
    
    // Configuration des filtres
    function setupFilters() {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          // Mettre √† jour l'√©tat actif
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // Appliquer le filtre
          currentFilter = this.dataset.filter;
          displayData();
        });
      });
    }
    
    // Charger les donn√©es publiques
    async function loadPublicData() {
      try {
        allData = [];
        
        // Charger les sentiers
        const trailsSnapshot = await db.collection('trails').get();
        const trails = new Map();
        trailsSnapshot.forEach(doc => {
          trails.set(doc.id, { id: doc.id, ...doc.data() });
        });
        
        // Charger les abris
        const sheltersSnapshot = await db.collection('shelters').get();
        const shelters = new Map();
        sheltersSnapshot.forEach(doc => {
          shelters.set(doc.id, { id: doc.id, ...doc.data() });
        });
        
        // Charger les derni√®res inspections de sentiers
        for (const [trailId, trail] of trails) {
          const inspectionSnapshot = await db.collection('trail_inspections')
            .where('trail_id', '==', trailId)
            .orderBy('date', 'desc')
            .limit(1)
            .get();
          
          let status = 'not-inspected';
          let lastInspection = null;
          
          if (!inspectionSnapshot.empty) {
            const doc = inspectionSnapshot.docs[0];
            lastInspection = doc.data();
            status = lastInspection.condition || 'not-inspected';
          }
          
          allData.push({
            type: 'trail',
            ...trail,
            status,
            lastInspection
          });
        }
        
        // Charger les derni√®res inspections d'abris
        for (const [shelterId, shelter] of shelters) {
          const inspectionSnapshot = await db.collection('shelter_inspections')
            .where('shelter_id', '==', shelterId)
            .orderBy('date', 'desc')
            .limit(1)
            .get();
          
          let status = 'not-inspected';
          let lastInspection = null;
          
          if (!inspectionSnapshot.empty) {
            const doc = inspectionSnapshot.docs[0];
            lastInspection = doc.data();
            status = lastInspection.condition || 'not-inspected';
          }
          
          allData.push({
            type: 'shelter',
            ...shelter,
            status,
            lastInspection
          });
        }
        
        // Trier par criticit√© puis par nom
        allData.sort((a, b) => {
          const statusOrder = { 'critical': 0, 'warning': 1, 'good': 2, 'not-inspected': 3 };
          const statusDiff = statusOrder[a.status] - statusOrder[b.status];
          if (statusDiff !== 0) return statusDiff;
          return a.name.localeCompare(b.name);
        });
        
        // Mettre √† jour l'heure de derni√®re mise √† jour
        const now = new Date();
        document.getElementById('last-update-time').textContent = 
          `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()} √† ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        
        // Afficher les donn√©es
        displayData();
        updateStatistics();
        
      } catch (error) {
        console.error("Erreur lors du chargement des donn√©es:", error);
        document.getElementById('status-grid').innerHTML = 
          '<div class="no-results">Erreur lors du chargement des donn√©es. Veuillez r√©essayer plus tard.</div>';
      }
    }
    
    // Afficher les donn√©es filtr√©es
    function displayData() {
      const grid = document.getElementById('status-grid');
      
      // Filtrer les donn√©es
      let filteredData = allData;
      
      switch (currentFilter) {
        case 'trails':
          filteredData = allData.filter(item => item.type === 'trail');
          break;
        case 'shelters':
          filteredData = allData.filter(item => item.type === 'shelter');
          break;
        case 'good':
          filteredData = allData.filter(item => item.status === 'good');
          break;
        case 'warning':
          filteredData = allData.filter(item => item.status === 'warning');
          break;
        case 'critical':
          filteredData = allData.filter(item => item.status === 'critical');
          break;
        case 'issues':
          filteredData = allData.filter(item => 
            item.lastInspection && item.lastInspection.issues && item.lastInspection.issues.length > 0
          );
          break;
      }
      
      // Vider la grille
      grid.innerHTML = '';
      
      if (filteredData.length === 0) {
        grid.innerHTML = '<div class="no-results">Aucun √©l√©ment ne correspond aux crit√®res s√©lectionn√©s.</div>';
        return;
      }
      
      // Cr√©er les cartes
      filteredData.forEach(item => {
        const card = createStatusCard(item);
        grid.appendChild(card);
      });
    }
    
    // Cr√©er une carte de statut
    function createStatusCard(item) {
      const card = document.createElement('div');
      card.className = `status-card ${item.status}`;
      
      // Type et nom
      const typeText = item.type === 'trail' ? 'Sentier' : 'Abri';
      let difficultyBadge = '';
      
      if (item.type === 'trail' && item.difficulty) {
        const difficultyClass = `difficulty-${item.difficulty}`;
        const difficultyText = {
          'easy': 'Facile',
          'medium': 'Interm√©diaire', 
          'hard': 'Difficile'
        }[item.difficulty] || item.difficulty;
        
        difficultyBadge = `<span class="difficulty-badge ${difficultyClass}">${difficultyText}</span>`;
      }
      
      // √âtat
      const statusText = {
        'good': 'Bon √©tat',
        'warning': 'Attention',
        'critical': 'Critique',
        'not-inspected': 'Non inspect√©'
      }[item.status] || 'Inconnu';
      
      // Date de derni√®re inspection
      let inspectionDate = 'Jamais inspect√©';
      if (item.lastInspection && item.lastInspection.date) {
        const date = item.lastInspection.date.toDate();
        const days = Math.floor((new Date() - date) / (1000 * 60 * 60 * 24));
        
        if (days === 0) {
          inspectionDate = "Aujourd'hui";
        } else if (days === 1) {
          inspectionDate = "Hier";
        } else if (days < 7) {
          inspectionDate = `Il y a ${days} jours`;
        } else if (days < 30) {
          const weeks = Math.floor(days / 7);
          inspectionDate = `Il y a ${weeks} semaine${weeks > 1 ? 's' : ''}`;
        } else {
          inspectionDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
        }
      }
      
      // Caract√©ristiques
      let characteristics = '';
      if (item.type === 'trail' && item.length) {
        characteristics = `${item.length} km`;
      } else if (item.type === 'shelter' && item.altitude) {
        characteristics = `${item.altitude} m d'altitude`;
      }
      
      // Probl√®mes
      let issuesHTML = '';
      if (item.lastInspection && item.lastInspection.issues && item.lastInspection.issues.length > 0) {
        issuesHTML = `
          <div class="issues-section">
            <div class="issues-title">‚ö†Ô∏è Probl√®mes signal√©s:</div>
            ${item.lastInspection.issues.map(issue => 
              `<div class="issue-item">‚Ä¢ ${issue}</div>`
            ).join('')}
          </div>
        `;
      }
      
      // Construire la carte
      card.innerHTML = `
        <div class="trail-header">
          <div>
            <h3 class="trail-name">${item.name}${difficultyBadge}</h3>
            <div class="trail-type">${typeText}</div>
          </div>
          <div class="status-indicator status-${item.status}">${statusText}</div>
        </div>
        
        <div class="trail-details">
          <div class="detail-row">
            <span class="detail-label">Derni√®re inspection:</span>
            <span class="detail-value">${inspectionDate}</span>
          </div>
          ${characteristics ? `
            <div class="detail-row">
              <span class="detail-label">Caract√©ristiques:</span>
              <span class="detail-value">${characteristics}</span>
            </div>
          ` : ''}
        </div>
        
        ${issuesHTML}
      `;
      
      return card;
    }
    
    // Mettre √† jour les statistiques
    function updateStatistics() {
      const stats = {
        trails: 0,
        shelters: 0,
        good: 0,
        warning: 0,
        critical: 0
      };
      
      allData.forEach(item => {
        if (item.type === 'trail') stats.trails++;
        if (item.type === 'shelter') stats.shelters++;
        
        switch (item.status) {
          case 'good': stats.good++; break;
          case 'warning': stats.warning++; break;
          case 'critical': stats.critical++; break;
        }
      });
      
      document.getElementById('total-trails').textContent = stats.trails;
      document.getElementById('total-shelters').textContent = stats.shelters;
      document.getElementById('good-count').textContent = stats.good;
      document.getElementById('warning-count').textContent = stats.warning;
      document.getElementById('critical-count').textContent = stats.critical;
    }
  </script>
</body>
</html>