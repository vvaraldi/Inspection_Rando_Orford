<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ski-Track - Administration</title>
  <link rel="stylesheet" href="../css/styles.css">
</head>

<script>
  window.onerror = function(message, source, lineno, colno, error) {
    console.log("Erreur JavaScript: ", message, "√† la ligne", lineno, "colonne", colno);
    console.log("Source:", source);
    console.log("Erreur compl√®te:", error);
    
    return true;
  };
</script>

<body>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèîÔ∏è</text></svg>">
<header>
    <nav>
      <div class="logo">Ski-Track</div>
      <div class="nav-links">
		<a href="../index.html">Tableau de bord</a>
		<a href="trail-inspection.html">Inspection sentier</a>
		<a href="shelter-inspection.html">Inspection abri</a>
		<a href="inspection-history.html">Historique</a>
		<a href="admin.html" class="active" >Administration</a>
		<a href="change-password.html">Mot de passe</a>
		<a href="#" id="login-link">Connexion</a>
      </div>
      <button class="mobile-menu-btn" id="mobile-menu-btn">‚ò∞</button>
    </nav>
    
    <div class="mobile-nav" id="mobile-nav">
      <div class="mobile-nav-header">
        <div class="logo">Ski-Track</div>
        <button class="mobile-nav-close" id="mobile-nav-close">‚úï</button>
      </div>
      <div class="mobile-nav-links">
        <a href="../index.html">Tableau de bord</a>
        <a href="trail-inspection.html">Inspection sentier</a>
        <a href="shelter-inspection.html">Inspection abri</a>
        <a href="inspection-history.html">Historique</a>
        <a href="admin.html" class="active" id="mobile-admin-link">Administration</a>
		<a href="change-password.html" id="mobile-password-link">Mot de passe</a>
        <a href="#" id="mobile-login-link">Connexion</a>
      </div>
    </div>
  </header>
  
  <main>
    <div class="page-header">
      <h1>Panneau d'administration</h1>
      <div id="user-info">Connect√© en tant que: <span id="admin-name">Administrateur</span></div>
    </div>
    
    <div class="tabs">
      <div class="tab active" data-tab="users">Gestion des utilisateurs</div>
      <div class="tab" data-tab="data">Donn√©es du syst√®me</div>
      <div class="tab" data-tab="stats">Statistiques (pas encore actif)</div>
    </div>
    
    <div class="tab-content active" id="users-tab">
      <div class="admin-panel">
        <div class="admin-card  full-width">
          <h2 class="admin-title">Liste des utilisateurs</h2>
          
          <table id="inspectors-table">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Email</th>
                <th>T√©l√©phone</th>
				<th>R√¥le</th>
				<th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
			<tbody>
			  <tr>
				<td colspan="6" style="text-align: center;">Chargement des utilisateurs...</td>
			  </tr>
			</tbody>
          </table>
        </div>
        
        <div class="admin-card full-width">
          <h2 class="admin-title">Nouvel utilisateur</h2>
          
          <form id="user-form">
            <div class="form-group">
              <label for="user-name">Nom complet</label>
              <input type="text" id="user-name" required>
            </div>
            
            <div class="form-group">
              <label for="user-email">Email</label>
              <input type="email" id="user-email" required>
            </div>
            
            <div class="form-group">
              <label for="user-phone">T√©l√©phone (optionnel)</label>
              <input type="tel" id="user-phone" placeholder="Ex: 06 12 34 56 78">
            </div>
            
            <div class="form-group">
              <label for="user-password">Mot de passe</label>
              <input type="password" id="user-password" required>
            </div>
            
			<div class="form-group">
			  <label for="user-role">R√¥le</label>
			  <select id="user-role">
				<option value="inspector">Inspecteur</option>
				<option value="admin">Administrateur</option>
			  </select>
			</div>

            <div class="form-group">
              <label for="user-status">Statut</label>
              <select id="user-status">
                <option value="active">Actif</option>
                <option value="inactive">Inactif</option>
              </select>
            </div>
            
            <div class="actions">
              <button type="button" id="cancel-user-btn" class="btn btn-secondary">Annuler</button>
              <button type="submit" class="btn btn-success">Enregistrer</button>
            </div>
          </form>
          
          <div id="user-status-message" class="status-message" style="display: none;"></div>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="data-tab">
      <div class="admin-panel">
        <div class="admin-card">
          <h2 class="admin-title">Initialisation des donn√©es</h2>
          
          <div class="admin-section">
            <h3>Sentiers</h3>
            <p>Initialiser les donn√©es des sentiers de randonn√©e alpine du Mont Orford.</p>
            <div class="actions">
              <button id="init-trails-btn" class="btn btn-warning" disabled>Initialiser les sentiers</button>
            </div>
            <div id="trails-status" class="status-message" style="display: none;"></div>
          </div>
          
          <div class="admin-section">
            <h3>Abris</h3>
            <p>Initialiser les donn√©es des abris des sommets du Mont Orford.</p>
            <div class="actions">
              <button id="init-shelters-btn" class="btn btn-warning" disabled>Initialiser les abris</button>
            </div>
            <div id="shelters-status" class="status-message" style="display: none;"></div>
          </div>
          
          <div class="admin-section">
            <h3>Donn√©es de test</h3>
            <p>Cr√©er des inspections de test pour simuler l'utilisation du syst√®me.</p>
            <div class="actions">
              <button id="create-sample-btn" class="btn" disabled>Cr√©er des donn√©es de test</button>
            </div>
            <div id="sample-status" class="status-message" style="display: none;"></div>
          </div>
        </div>
        
        <div class="admin-card">
          <h2 class="admin-title">Gestion des donn√©es</h2>

			<div class="admin-section">
			  <h3>Suppression des anciennes inspections</h3>
			  <p>Supprimer toutes les inspections ant√©rieures √† une date sp√©cifique.</p>
			  
			  <div class="form-group" style="margin-bottom: 1rem;">
				<label for="cutoff-date" style="display: block; margin-bottom: 0.5rem;">Date limite (supprimer avant cette date) :</label>
				<input 
				  type="date" 
				  id="cutoff-date" 
				  style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;"
				>
			  </div>
			  
			  <div class="actions">
				<button id="delete-old-inspections-btn" class="btn btn-danger">
				  Supprimer les anciennes inspections
				</button>
			  </div>
			  
			  <div id="delete-old-status" class="status-message" style="display: none;"></div>
			</div>
          
			<div class="admin-section">
			  <h3>Sauvegarde</h3>
			  <p>Exporter toutes les donn√©es du syst√®me en format JSON.</p>
			  <div class="actions">
			    <button id="export-data-btn" class="btn" disabled>Exporter les donn√©es</button>
			  </div>
			</div>

			<div class="admin-section">
			  <h3>R√©initialisation</h3>
			  <p>Attention: Cette action supprimera toutes les donn√©es d'inspection.</p>
			  <div class="actions">
			    <button id="reset-inspections-btn" class="btn btn-danger" disabled>R√©initialiser les inspections</button>
			  </div>
			<div id="reset-status" class="status-message" style="display: none;"></div>
			</div>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="stats-tab">
      <div class="admin-panel">
        <div class="admin-card">
          <h2 class="admin-title">Statistiques d'utilisation</h2>
          
          <div class="admin-section">
            <h3>R√©sum√© des inspections  (examples seulement... pas actif encore)</h3>
            <table>
              <tbody>
                <tr>
                  <td>Nombre total d'inspections</td>
                  <td><strong id="total-inspections">42</strong></td>
                </tr>
                <tr>
                  <td>Inspections cette semaine</td>
                  <td><strong id="week-inspections">12</strong></td>
                </tr>
                <tr>
                  <td>Inspections sentiers</td>
                  <td><strong id="trail-inspections">32</strong></td>
                </tr>
                <tr>
                  <td>Inspections abris</td>
                  <td><strong id="shelter-inspections">10</strong></td>
                </tr>
                <tr>
                  <td>Probl√®mes signal√©s non r√©solus</td>
                  <td><strong id="open-issues">7</strong></td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="admin-section">
            <h3>Activit√© des inspecteurs</h3>
            <table>
              <thead>
                <tr>
                  <th>Inspecteur</th>
                  <th>Inspections</th>
                  <th>Derni√®re activit√©</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Pierre Martin</td>
                  <td>15</td>
                  <td>14/04/2025</td>
                </tr>
                <tr>
                  <td>Sophie Legrand</td>
                  <td>18</td>
                  <td>13/04/2025</td>
                </tr>
                <tr>
                  <td>Marc Dubois</td>
                  <td>9</td>
                  <td>12/04/2025</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="admin-card">
          <h2 class="admin-title">√âtat du syst√®me</h2>
          
          <div class="admin-section">
            <h3>Utilisation Firebase</h3>
            <table>
              <tbody>
                <tr>
                  <td>Stockage utilis√©</td>
                  <td><strong id="storage-used">12.5 MB</strong></td>
                </tr>
                <tr>
                  <td>Requ√™tes Firestore ce mois</td>
                  <td><strong id="firestore-requests">1,253</strong></td>
                </tr>
                <tr>
                  <td>Utilisateurs actifs</td>
                  <td><strong id="active-users">3</strong></td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="admin-section">
            <h3>Maintenance</h3>
            <div class="actions">
              <button disabled id="clear-cache-btn" class="btn">Vider le cache</button>
              <button id="check-updates-btn" class="btn" disabled>V√©rifier les mises √† jour</button>
            </div>
            <div id="maintenance-status" class="status-message" style="display: none;"></div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <div id="delete-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Confirmer la suppression</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <p>√ätes-vous s√ªr de vouloir supprimer cet utilisateur? Cette action est irr√©versible.</p>
        <p>Toutes les inspections associ√©es √† cet utilisateur seront conserv√©es.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary modal-cancel">Annuler</button>
        <button class="btn btn-danger" id="confirm-delete">Supprimer</button>
      </div>
    </div>
  </div>
  
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

<script src="../js/auth.js"></script>
<script src="../js/mobile-menu.js"></script>
<script src="../js/dashboard.js"></script>

<script>
// =====================================================
// SCRIPT PRINCIPAL - PAGE D'ADMINISTRATION
// =====================================================

document.addEventListener('DOMContentLoaded', function() {
  // ===== INITIALISATION DES SERVICES FIREBASE =====
  const auth = firebase.auth();
  const db = firebase.firestore();
  
  // IMPORTANT: Initialisation globale de Firebase Storage
  let storage = null;
  try {
    storage = firebase.storage();
    console.log("‚úì Firebase Storage initialis√© avec succ√®s");
  } catch (error) {
    console.warn("‚ö† Firebase Storage n'est pas disponible:", error);
    console.warn("Les fonctionnalit√©s de suppression de photos seront limit√©es");
  }
  
  // Variable pour stocker l'ID de l'utilisateur actuellement connect√©
  let currentUserId = null;
  
  // ===== V√âRIFICATION DE L'AUTHENTIFICATION =====
  auth.onAuthStateChanged(function(user) {
    if (user) {
      currentUserId = user.uid; // Stocker l'ID de l'utilisateur connect√©
      
      // V√©rifier si l'utilisateur est admin
      db.collection('inspectors').doc(user.uid).get()
        .then(doc => {
          if (doc.exists && doc.data().role === 'admin') {
            document.getElementById('admin-name').textContent = doc.data().name;
            loadInspectors();
            loadStatistics();
          } else {
            window.location.href = '../index.html';
          }
        })
        .catch(error => {
          console.error("Erreur lors de la v√©rification des privil√®ges:", error);
          window.location.href = '../index.html';
        });
    } else {
      window.location.href = 'login.html';
    }
  });
  
  // ===== GESTION DES ONGLETS =====
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.remove('active');
      });
      this.classList.add('active');
      
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      const tabId = this.getAttribute('data-tab') + '-tab';
      document.getElementById(tabId).classList.add('active');
    });
  });
  
  // ===== GESTION DES INSPECTEURS =====
  function loadInspectors() {
    db.collection('inspectors').get()
      .then(snapshot => {
        const table = document.getElementById('inspectors-table').querySelector('tbody');
        table.innerHTML = '';
        
        if (snapshot.empty) {
          table.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucun utilisateur trouv√©</td></tr>';
          return;
        }
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const row = document.createElement('tr');
          
          // D√©terminer si c'est l'utilisateur connect√©
          const isCurrentUser = (doc.id === currentUserId);
          
          // Cr√©er le bouton de r√¥le (d√©sactiv√© si c'est l'utilisateur connect√©)
          const roleText = data.role === 'admin' ? 'Administrateur' : 'Inspecteur';
          const roleClass = data.role === 'admin' ? 'role-admin' : 'role-inspector';
          
          let roleButtonHtml = '';
          if (isCurrentUser) {
            // Si c'est l'utilisateur connect√©, afficher juste un badge non cliquable
            roleButtonHtml = `<span class="role-badge ${roleClass}" title="Vous ne pouvez pas modifier votre propre r√¥le">${roleText}</span>`;
          } else {
            // Sinon, cr√©er un bouton cliquable
            roleButtonHtml = `
              <button class="role-toggle-btn role-badge ${roleClass}" 
                      data-user-id="${doc.id}" 
                      data-current-role="${data.role}"
                      title="Cliquer pour changer le r√¥le">
                ${roleText}
              </button>
            `;
          }
          
          // Cr√©er le bouton de statut (d√©sactiv√© si c'est l'utilisateur connect√©)
          const statusText = data.status === 'active' ? 'Actif' : 'Inactif';
          const statusClass = data.status === 'active' ? 'status-active' : 'status-inactive';
          
          let statusButtonHtml = '';
          if (isCurrentUser) {
            // Si c'est l'utilisateur connect√©, afficher juste un badge non cliquable
            statusButtonHtml = `<span class="status-badge ${statusClass}" title="Vous ne pouvez pas modifier votre propre statut">${statusText}</span>`;
          } else {
            // Sinon, cr√©er un bouton cliquable
            statusButtonHtml = `
              <button class="status-toggle-btn status-badge ${statusClass}" 
                      data-user-id="${doc.id}" 
                      data-current-status="${data.status}"
                      title="Cliquer pour changer le statut">
                ${statusText}
              </button>
            `;
          }
          
          // D√©sactiver le bouton de suppression si c'est l'utilisateur connect√©
          const deleteButtonHtml = isCurrentUser 
            ? '<button class="btn btn-secondary btn-sm" disabled title="Vous ne pouvez pas supprimer votre propre compte">Supprimer</button>'
            : `<button class="btn btn-danger btn-sm delete-user" data-id="${doc.id}">Supprimer</button>`;
          
          row.innerHTML = `
            <td>${data.name}${isCurrentUser ? ' <span style="color: #1a56db;">(Vous)</span>' : ''}</td>
            <td>${data.email}</td>
            <td>${data.phone || '-'}</td>
            <td>${roleButtonHtml}</td>
            <td>${statusButtonHtml}</td>
            <td>${deleteButtonHtml}</td>
          `;
          
          table.appendChild(row);
        });
        
        // Configurer les √©v√©nements apr√®s cr√©ation des √©l√©ments
        setupUserActions();
        setupStatusToggle();
        setupRoleToggle(); // Nouvelle fonction pour g√©rer les boutons de r√¥le
      })
      .catch(error => {
        console.error("Erreur lors du chargement des inspecteurs:", error);
        showStatus('user-status-message', 'Erreur lors du chargement des inspecteurs.', 'error');
      });
  }

  // Nouvelle fonction pour g√©rer les boutons de basculement de r√¥le
  function setupRoleToggle() {
    document.querySelectorAll('.role-toggle-btn').forEach(button => {
      button.addEventListener('click', async function() {
        const userId = this.getAttribute('data-user-id');
        const currentRole = this.getAttribute('data-current-role');
        const newRole = currentRole === 'admin' ? 'inspector' : 'admin';
        
        // Confirmation pour les changements de r√¥le sensibles
        const confirmMessage = newRole === 'admin' 
          ? '√ätes-vous s√ªr de vouloir donner les droits administrateur √† cet utilisateur?'
          : '√ätes-vous s√ªr de vouloir retirer les droits administrateur √† cet utilisateur?';
        
        if (!confirm(confirmMessage)) {
          return;
        }
        
        // D√©sactiver le bouton pendant la requ√™te
        this.disabled = true;
        this.textContent = 'Modification...';
        
        try {
          // Mettre √† jour le r√¥le dans Firestore
          await db.collection('inspectors').doc(userId).update({
            role: newRole,
            lastModified: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // Mettre √† jour l'affichage du bouton
          const newRoleText = newRole === 'admin' ? 'Administrateur' : 'Inspecteur';
          const newRoleClass = newRole === 'admin' ? 'role-admin' : 'role-inspector';
          
          this.textContent = newRoleText;
          this.className = `role-toggle-btn role-badge ${newRoleClass}`;
          this.setAttribute('data-current-role', newRole);
          
          // Afficher un message de succ√®s temporaire
          showTemporaryMessage(`R√¥le mis √† jour : ${newRoleText}`, 'success');
          
        } catch (error) {
          console.error('Erreur lors de la mise √† jour du r√¥le:', error);
          
          // Restaurer l'√©tat original en cas d'erreur
          const originalText = currentRole === 'admin' ? 'Administrateur' : 'Inspecteur';
          const originalClass = currentRole === 'admin' ? 'role-admin' : 'role-inspector';
          
          this.textContent = originalText;
          this.className = `role-toggle-btn role-badge ${originalClass}`;
          
          showTemporaryMessage('Erreur lors de la mise √† jour du r√¥le', 'error');
        } finally {
          // R√©activer le bouton
          this.disabled = false;
        }
      });
    });
  }

  // Fonction pour g√©rer les boutons de basculement de statut
  function setupStatusToggle() {
    document.querySelectorAll('.status-toggle-btn').forEach(button => {
      button.addEventListener('click', async function() {
        const userId = this.getAttribute('data-user-id');
        const currentStatus = this.getAttribute('data-current-status');
        const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
        
        // D√©sactiver le bouton pendant la requ√™te
        this.disabled = true;
        this.textContent = 'Modification...';
        
        try {
          // Mettre √† jour le statut dans Firestore
          await db.collection('inspectors').doc(userId).update({
            status: newStatus,
            lastModified: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // Mettre √† jour l'affichage du bouton
          const newStatusText = newStatus === 'active' ? 'Actif' : 'Inactif';
          const newStatusClass = newStatus === 'active' ? 'status-active' : 'status-inactive';
          
          this.textContent = newStatusText;
          this.className = `status-toggle-btn status-badge ${newStatusClass}`;
          this.setAttribute('data-current-status', newStatus);
          
          showTemporaryMessage(`Statut mis √† jour : ${newStatusText}`, 'success');
          
        } catch (error) {
          console.error('Erreur lors de la mise √† jour du statut:', error);
          
          const originalText = currentStatus === 'active' ? 'Actif' : 'Inactif';
          const originalClass = currentStatus === 'active' ? 'status-active' : 'status-inactive';
          
          this.textContent = originalText;
          this.className = `status-toggle-btn status-badge ${originalClass}`;
          
          showTemporaryMessage('Erreur lors de la mise √† jour du statut', 'error');
        } finally {
          this.disabled = false;
        }
      });
    });
  }

  // Fonction utilitaire pour afficher un message temporaire
  function showTemporaryMessage(message, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `status-message status-${type} temporary-message`;
    messageDiv.textContent = message;
    messageDiv.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 0.75rem 1.5rem;
      border-radius: 0.375rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.3s ease-out;
    `;
    
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
      messageDiv.style.animation = 'slideOut 0.3s ease-out';
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.parentNode.removeChild(messageDiv);
        }
      }, 300);
    }, 3000);
  }
  
  // Configurer les actions pour les utilisateurs
  function setupUserActions() {
    // Soumission du formulaire
    document.getElementById('user-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const name = document.getElementById('user-name').value;
      const email = document.getElementById('user-email').value;
      const phone = document.getElementById('user-phone').value;
      const password = document.getElementById('user-password').value;
      const role = document.getElementById('user-role').value;
      const status = document.getElementById('user-status').value;
      
      const submitBtn = this.querySelector('button[type="submit"]');
      if (submitBtn) submitBtn.disabled = true;

      auth.createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          console.log("Utilisateur cr√©√© dans Auth:", userCredential.user.uid);
          
          return db.collection('inspectors').doc(userCredential.user.uid).set({
            name: name,
            email: email,
            phone: phone || null,
            status: status,
            role: role,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        })
        .then(() => {
          console.log("Inspecteur ajout√© √† Firestore avec succ√®s");
          showStatus('user-status-message', 'Inspecteur cr√©√© avec succ√®s!', 'success');
          document.getElementById('user-form').reset();
          if (submitBtn) submitBtn.disabled = false;
          loadInspectors();
        })
        .catch(error => {
          console.error("Erreur lors de la cr√©ation de l'inspecteur:", error);
          showStatus('user-status-message', 'Erreur: ' + error.message, 'error');
          if (submitBtn) submitBtn.disabled = false;
        });
    });
  
    // Bouton d'annulation du formulaire
    document.getElementById('cancel-user-btn').addEventListener('click', function() {
      document.getElementById('user-form').reset();
    });
    
    // Boutons de suppression
    document.querySelectorAll('.delete-user').forEach(button => {
      button.addEventListener('click', async function() {
        const userId = this.getAttribute('data-id');
        
        if (confirm('√ätes-vous s√ªr de vouloir supprimer cet utilisateur? Cette action est irr√©versible.')) {
          const loadingIndicator = document.querySelector('.loading-indicator');
          if (loadingIndicator) loadingIndicator.style.display = 'block';
          
          this.disabled = true;
          
          const result = await deleteUser(userId);
          
          if (loadingIndicator) loadingIndicator.style.display = 'none';
          
          if (result.success) {
            alert(result.message);
            loadInspectors();
          } else {
            alert(result.message);
            this.disabled = false;
          }
        }
      });
    });
    
    // Gestion de la modal
    const closeModalBtn = document.querySelector('.modal-close');
    const cancelModalBtn = document.querySelector('.modal-cancel');
    
    if (closeModalBtn) {
      closeModalBtn.addEventListener('click', function() {
        document.getElementById('delete-modal').style.display = 'none';
      });
    }
    
    if (cancelModalBtn) {
      cancelModalBtn.addEventListener('click', function() {
        document.getElementById('delete-modal').style.display = 'none';
      });
    }
  }

  // ===== GESTION DES STATISTIQUES =====
  function loadStatistics() {
    console.log('Chargement des statistiques...');
  }
  
  // ===== INITIALISATION DES DONN√âES =====
  document.getElementById('init-trails-btn').addEventListener('click', function() {
    if (this.disabled) {
      e.preventDefault();
      return;
    }
    if (confirm('√ätes-vous s√ªr de vouloir initialiser les donn√©es des sentiers? Cela √©crasera toutes les donn√©es existantes.')) {
      showStatus('trails-status', 'Initialisation en cours...', 'info');
      
      const trailsData = [
        {
          id: 'trail_1',
          name: "La tortue",
          length: 1.1,
          difficulty: "easy",
          description: "Sentier facile id√©al pour d√©butants",
          coordinates: { top: 394, left: 450 }
        },
        {
          id: 'trail_2',
          name: "Trac√© du lynx",
          length: 0.6,
          difficulty: "easy",
          description: "Court sentier avec peu de d√©nivel√©",
          coordinates: { top: 323, left: 210 }
        },
        {
          id: 'trail_3',
          name: "Adams",
          length: 0.6,
          difficulty: "easy",
          description: "Sentier familial accessible",
          coordinates: { top: 520, left: 420 }
        },
        {
          id: 'trail_4',
          name: "Le renard",
          length: 2.4,
          difficulty: "easy",
          description: "Sentier plus long mais avec pente douce",
          coordinates: { top: 430, left: 45 }
        },
        {
          id: 'trail_5',
          name: "Le li√®vre",
          length: 1.3,
          difficulty: "medium",
          description: "Sentier interm√©diaire avec quelques pentes",
          coordinates: { top: 145, left: 283 }
        },
        {
          id: 'trail_6',
          name: "Le Campagnol",
          length: 1.5,
          difficulty: "hard",
          description: "Sentier difficile pour randonneurs exp√©riment√©s",
          coordinates: { top: 20, left: 426 }
        },
        {
          id: 'trail_7',
          name: "L'Hermine",
          length: 1.8,
          difficulty: "medium",
          description: "Sentier interm√©diaire avec belle vue",
          coordinates: { top: 372, left: 530 }
        },
        {
          id: 'trail_8',
          name: "L'Alouette",
          length: 2.4,
          difficulty: "medium",
          description: "Sentier avec d√©nivel√© mod√©r√©",
          coordinates: { top: 410, left: 661 }
        },
        {
          id: 'trail_9',
          name: "L'Urubu",
          length: 1.2,
          difficulty: "hard",
          description: "Sentier technique et escarp√©",
          coordinates: { top: 504, left: 255 }
        },
        {
          id: 'trail_10',
          name: "La Carcajou",
          length: 0.8,
          difficulty: "hard",
          description: "Court sentier mais tr√®s exigeant",
          coordinates: { top: 470, left: 288 }
        },
        {
          id: 'trail_11',
          name: "La Mille-Pattes",
          length: 1.5,
          difficulty: "hard",
          description: "Sentier avec plusieurs segments techniques",
          coordinates: { top: 308, left: 518 }
        }
      ];
      
      const batch = db.batch();
      
      db.collection('trails').get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            batch.delete(doc.ref);
          });
          
          trailsData.forEach(trail => {
            const docRef = db.collection('trails').doc(trail.id);
            batch.set(docRef, {
              name: trail.name,
              length: trail.length,
              difficulty: trail.difficulty,
              description: trail.description,
              coordinates: trail.coordinates,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          });
          
          return batch.commit();
        })
        .then(() => {
          showStatus('trails-status', 'Donn√©es des sentiers initialis√©es avec succ√®s!', 'success');
        })
        .catch(error => {
          console.error("Erreur lors de l'initialisation des sentiers:", error);
          showStatus('trails-status', 'Erreur: ' + error.message, 'error');
        });
    }
  });
  
  document.getElementById('init-shelters-btn').addEventListener('click', function() {
    if (this.disabled) {
      e.preventDefault();
      return;
    }
    if (confirm('√ätes-vous s√ªr de vouloir initialiser les donn√©es des abris? Cela √©crasera toutes les donn√©es existantes.')) {
      showStatus('shelters-status', 'Initialisation en cours...', 'info');
      
      const sheltersData = [
        {
          id: 'shelter_1',
          name: "Mont Giroux",
          altitude: 650,
          coordinates: { top: 457, left: 134 }
        },
        {
          id: 'shelter_2',
          name: "Mont Orford",
          altitude: 850,
          coordinates: { top: 41, left: 470 }
        },
        {
          id: 'shelter_3',
          name: "Mont Alfred-Desrochers",
          altitude: 615,
          coordinates: { top: 176, left: 621 }
        }
      ];
      
      const batch = db.batch();
      
      db.collection('shelters').get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            batch.delete(doc.ref);
          });
          
          sheltersData.forEach(shelter => {
            const docRef = db.collection('shelters').doc(shelter.id);
            batch.set(docRef, {
              name: shelter.name,
              altitude: shelter.altitude,
              coordinates: shelter.coordinates,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          });
          
          return batch.commit();
        })
        .then(() => {
          showStatus('shelters-status', 'Donn√©es des abris initialis√©es avec succ√®s!', 'success');
        })
        .catch(error => {
          console.error("Erreur lors de l'initialisation des abris:", error);
          showStatus('shelters-status', 'Erreur: ' + error.message, 'error');
        });
    }
  });
  
  document.getElementById('create-sample-btn').addEventListener('click', function() {
    if (this.disabled) {
      e.preventDefault();
      return;
    }
    if (confirm('Voulez-vous cr√©er des donn√©es d\'inspection de test? Cela ajoutera plusieurs inspections fictives.')) {
      showStatus('sample-status', 'Cr√©ation des donn√©es de test en cours...', 'info');
      
      setTimeout(() => {
        showStatus('sample-status', 'Donn√©es de test cr√©√©es avec succ√®s!', 'success');
      }, 1500);
    }
  });
  
  document.getElementById('reset-inspections-btn').addEventListener('click', function() {
    if (this.disabled) {
      e.preventDefault();
      return;
    }
    if (confirm('ATTENTION: Voulez-vous vraiment supprimer TOUTES les inspections? Cette action est irr√©versible.')) {
      showStatus('reset-status', 'R√©initialisation en cours...', 'warning');
      
      const trailBatch = db.batch();
      const shelterBatch = db.batch();
      
      db.collection('trail_inspections').get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            trailBatch.delete(doc.ref);
          });
          return trailBatch.commit();
        })
        .then(() => {
          return db.collection('shelter_inspections').get();
        })
        .then(snapshot => {
          snapshot.forEach(doc => {
            shelterBatch.delete(doc.ref);
          });
          return shelterBatch.commit();
        })
        .then(() => {
          showStatus('reset-status', 'Toutes les inspections ont √©t√© supprim√©es.', 'success');
          loadStatistics();
        })
        .catch(error => {
          console.error("Erreur lors de la r√©initialisation:", error);
          showStatus('reset-status', 'Erreur: ' + error.message, 'error');
        });
    }
  });
  
  document.getElementById('export-data-btn').addEventListener('click', function() {
    if (this.disabled) {
      e.preventDefault();
      return;
    }
    alert('Fonctionnalit√© d\'exportation en cours de d√©veloppement.');
  });
  
  document.getElementById('clear-cache-btn').addEventListener('click', function() {
    if (this.disabled) {
      e.preventDefault();
      return;
    }
    showStatus('maintenance-status', 'Nettoyage du cache en cours...', 'info');
    
    setTimeout(() => {
      showStatus('maintenance-status', 'Cache nettoy√© avec succ√®s!', 'success');
    }, 1000);
  });
  
  document.getElementById('check-updates-btn').addEventListener('click', function() {
    if (this.disabled) {
      e.preventDefault();
      return;
    }
    showStatus('maintenance-status', 'V√©rification des mises √† jour...', 'info');
    
    setTimeout(() => {
      showStatus('maintenance-status', 'Votre syst√®me est √† jour!', 'success');
    }, 1500);
  });
  
  if (document.getElementById('logout-link')) {
    document.getElementById('logout-link').addEventListener('click', function(e) {
      e.preventDefault();
      
      auth.signOut()
        .then(() => {
          window.location.href = 'login.html';
        })
        .catch(error => {
          console.error("Erreur lors de la d√©connexion:", error);
        });
    });
  }
  
  function showStatus(elementId, message, type) {
    const statusElement = document.getElementById(elementId);
    if (!statusElement) return;
    
    statusElement.textContent = message;
    statusElement.className = 'status-message status-' + type;
    statusElement.style.display = 'block';
    
    if (type !== 'error') {
      setTimeout(() => {
        statusElement.style.display = 'none';
      }, 5000);
    }
  }

  async function deleteUser(userId) {
    try {
      const userDoc = await db.collection('inspectors').doc(userId).get();
      
      if (!userDoc.exists) {
        throw new Error("Utilisateur non trouv√© dans la base de donn√©es");
      }
      
      await db.collection('inspectors').doc(userId).delete();
      
      const trailInspectionsSnapshot = await db.collection('trail_inspections')
        .where('inspector_id', '==', userId)
        .get();
      
      if (!trailInspectionsSnapshot.empty) {
        const trailBatch = db.batch();
        trailInspectionsSnapshot.forEach(doc => {
          trailBatch.delete(doc.ref);
        });
        await trailBatch.commit();
      }
      
      const shelterInspectionsSnapshot = await db.collection('shelter_inspections')
        .where('inspector_id', '==', userId)
        .get();
      
      if (!shelterInspectionsSnapshot.empty) {
        const shelterBatch = db.batch();
        shelterInspectionsSnapshot.forEach(doc => {
          shelterBatch.delete(doc.ref);
        });
        await shelterBatch.commit();
      }
      
      console.log("Utilisateur supprim√© de Firestore avec succ√®s");
      
      return {
        success: true,
        message: "Donn√©es utilisateur supprim√©es. Veuillez contacter l'administrateur pour compl√©ter la suppression du compte."
      };
    } catch (error) {
      console.error("Erreur lors de la suppression de l'utilisateur:", error);
      
      return {
        success: false,
        message: "Erreur lors de la suppression: " + error.message
      };
    }
  }

  console.log('Script d\'administration initialis√©');

	// ===== SUPPRESSION DES ANCIENNES INSPECTIONS =====
	// ===================================================
	
	/**
	 * Initialise la date par d√©faut pour la suppression
	 * D√©finit la date √† 7 mois avant aujourd'hui
	 */
	const cutoffDateInput = document.getElementById('cutoff-date');
	if (cutoffDateInput) {
	  const today = new Date();
	  const sevenMonthsAgo = new Date(today);
	  sevenMonthsAgo.setMonth(sevenMonthsAgo.getMonth() - 7);
	  
	  // Formater la date pour l'input (YYYY-MM-DD)
	  const year = sevenMonthsAgo.getFullYear();
	  const month = String(sevenMonthsAgo.getMonth() + 1).padStart(2, '0');
	  const day = String(sevenMonthsAgo.getDate()).padStart(2, '0');
	  cutoffDateInput.value = `${year}-${month}-${day}`;
	}

	/**
	 * Gestionnaire pour le bouton de suppression des anciennes inspections
	 * Supprime les inspections et leurs photos associ√©es
	 */
	const deleteOldBtn = document.getElementById('delete-old-inspections-btn');
	if (deleteOldBtn) {
	  deleteOldBtn.addEventListener('click', async function() {
		const cutoffDateInput = document.getElementById('cutoff-date');
		
		if (!cutoffDateInput.value) {
		  alert('Veuillez s√©lectionner une date limite.');
		  return;
		}
		
		// Convertir la date s√©lectionn√©e en timestamp Firebase
		const cutoffDate = new Date(cutoffDateInput.value + 'T00:00:00');
		const cutoffTimestamp = firebase.firestore.Timestamp.fromDate(cutoffDate);
		
		// D√©sactiver le bouton pendant le traitement
		this.disabled = true;
		const originalText = this.textContent;
		this.textContent = 'Comptage des inspections...';
		
		try {
		  // Compter les inspections qui seront supprim√©es
		  let trailInspectionsToDelete = 0;
		  let shelterInspectionsToDelete = 0;
		  
		  // Compter les inspections de sentiers
		  const trailSnapshot = await db.collection('trail_inspections')
			.where('date', '<', cutoffTimestamp)
			.get();
		  trailInspectionsToDelete = trailSnapshot.size;
		  
		  // Compter les inspections d'abris
		  const shelterSnapshot = await db.collection('shelter_inspections')
			.where('date', '<', cutoffTimestamp)
			.get();
		  shelterInspectionsToDelete = shelterSnapshot.size;
		  
		  const totalToDelete = trailInspectionsToDelete + shelterInspectionsToDelete;
		  
		  if (totalToDelete === 0) {
			showStatus('delete-old-status', 'Aucune inspection trouv√©e avant cette date.', 'info');
			this.disabled = false;
			this.textContent = originalText;
			return;
		  }
		  
		  // Formater la date pour l'affichage
		  const formattedDate = cutoffDate.toLocaleDateString('fr-FR', {
			day: '2-digit',
			month: 'long',
			year: 'numeric'
		  });
		  
		  // Demander confirmation avec le nombre d'inspections
		  const confirmMessage = `ATTENTION: Vous √™tes sur le point de supprimer ${totalToDelete} inspection(s) ant√©rieure(s) au ${formattedDate}:\n\n` +
			`- ${trailInspectionsToDelete} inspection(s) de sentiers\n` +
			`- ${shelterInspectionsToDelete} inspection(s) d'abris\n\n` +
			`Cette action est IRR√âVERSIBLE. Voulez-vous continuer?`;
		  
		  if (!confirm(confirmMessage)) {
			this.disabled = false;
			this.textContent = originalText;
			return;
		  }
		  
		  // Proc√©der √† la suppression
		  this.textContent = 'Suppression en cours...';
		  showStatus('delete-old-status', 'Suppression des inspections en cours...', 'warning');
		  
		  let deletedCount = 0;
		  let photosDeleted = 0;
		  let photosFailed = 0;
		  
		  // V√©rifier si Firebase Storage est disponible (utiliser la variable globale)
		  const canDeletePhotos = storage !== null;
		  
		  if (!canDeletePhotos) {
			console.warn('‚ö† Firebase Storage non disponible - les photos ne seront pas supprim√©es');
		  }
		  
		  /**
		   * Fonction helper pour supprimer les photos d'une inspection
		   * @param {Object} inspectionData - Donn√©es de l'inspection
		   * @param {string} inspectionId - ID de l'inspection
		   * @param {string} inspectionType - Type d'inspection ('trails' ou 'shelters')
		   * @returns {Object} Nombre de photos supprim√©es et √©chou√©es
		   */
		  async function deleteInspectionPhotos(inspectionData, inspectionId, inspectionType) {
			if (!canDeletePhotos || !inspectionData.photos || inspectionData.photos.length === 0) {
			  return { deleted: 0, failed: 0 };
			}
			
			let deleted = 0;
			let failed = 0;
			
			for (const photoUrl of inspectionData.photos) {
			  try {
				// IMPORTANT: Utiliser la variable storage globale au lieu de firebase.storage()
				const photoRef = storage.refFromURL(photoUrl);
				await photoRef.delete();
				deleted++;
				console.log('‚úì Photo supprim√©e:', photoUrl);
			  } catch (error) {
				console.error('‚úó Erreur lors de la suppression de la photo:', photoUrl, error);
				failed++;
			  }
			}
			
			return { deleted, failed };
		  }
		  
		  // Supprimer les inspections de sentiers
		  if (trailInspectionsToDelete > 0) {
			this.textContent = `Suppression des inspections de sentiers...`;
			
			for (const doc of trailSnapshot.docs) {
			  const inspectionData = doc.data();
			  
			  // Supprimer les photos si possible
			  if (canDeletePhotos && inspectionData.photos && inspectionData.photos.length > 0) {
				this.textContent = `Suppression des photos... (${deletedCount + 1}/${totalToDelete})`;
				const photoResult = await deleteInspectionPhotos(inspectionData, doc.id, 'trails');
				photosDeleted += photoResult.deleted;
				photosFailed += photoResult.failed;
			  }
			  
			  // Supprimer le document d'inspection
			  await doc.ref.delete();
			  deletedCount++;
			  this.textContent = `Suppression... (${deletedCount}/${totalToDelete})`;
			}
		  }
		  
		  // Supprimer les inspections d'abris
		  if (shelterInspectionsToDelete > 0) {
			this.textContent = `Suppression des inspections d'abris...`;
			
			for (const doc of shelterSnapshot.docs) {
			  const inspectionData = doc.data();
			  
			  // Supprimer les photos si possible
			  if (canDeletePhotos && inspectionData.photos && inspectionData.photos.length > 0) {
				this.textContent = `Suppression des photos... (${deletedCount + 1}/${totalToDelete})`;
				const photoResult = await deleteInspectionPhotos(inspectionData, doc.id, 'shelters');
				photosDeleted += photoResult.deleted;
				photosFailed += photoResult.failed;
			  }
			  
			  // Supprimer le document d'inspection
			  await doc.ref.delete();
			  deletedCount++;
			  this.textContent = `Suppression... (${deletedCount}/${totalToDelete})`;
			}
		  }
		  
		  // Message de succ√®s avec d√©tails
		  let statusMessage = `‚úì ${totalToDelete} inspection(s) supprim√©e(s) avec succ√®s.`;
		  
		  if (canDeletePhotos) {
			if (photosDeleted > 0 || photosFailed > 0) {
			  statusMessage += ` ${photosDeleted} photo(s) supprim√©e(s).`;
			  if (photosFailed > 0) {
				statusMessage += ` ${photosFailed} photo(s) n'ont pas pu √™tre supprim√©es.`;
			  }
			}
		  } else {
			statusMessage += '\n‚ö† Note: Les photos n\'ont pas pu √™tre supprim√©es (Firebase Storage non configur√©).';
		  }
		  
		  showStatus('delete-old-status', statusMessage, 'success');
		  
		  // Recharger les statistiques si la fonction existe
		  if (typeof loadStatistics === 'function') {
			loadStatistics();
		  }
		  
		} catch (error) {
		  console.error("Erreur lors de la suppression des anciennes inspections:", error);
		  showStatus('delete-old-status', 'Erreur lors de la suppression: ' + error.message, 'error');
		} finally {
		  // R√©activer le bouton
		  this.disabled = false;
		  this.textContent = originalText;
		}
	  });
	}

});

</script>


</body>
</html>