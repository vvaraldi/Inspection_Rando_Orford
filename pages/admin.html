<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ski-Track - Administration</title>
  <link rel="stylesheet" href="../css/styles.css">
</head>

<script>
  window.onerror = function(message, source, lineno, colno, error) {
    console.log("Erreur JavaScript: ", message, "√† la ligne", lineno, "colonne", colno);
    console.log("Source:", source);
    console.log("Erreur compl√®te:", error);
    
    // Afficher le contenu en cas d'erreur
//    document.getElementById('loading').style.display = 'none';
//    document.getElementById('main-content').style.display = 'block';
    
    return true; // Emp√™che l'affichage de l'erreur dans la console
  };
</script>

<body>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèîÔ∏è</text></svg>">
<header>
    <nav>
      <div class="logo">Ski-Track</div>
      <div class="nav-links">
		<a href="../index.html">Tableau de bord</a>
		<a href="trail-inspection.html">Inspection sentier</a>
		<a href="shelter-inspection.html">Inspection abri</a>
		<a href="inspection-history.html">Historique</a>
		<a href="admin.html" class="active" >Administration</a>
		<a href="change-password.html">Mot de passe</a>
		<a href="#" id="login-link">Connexion</a>
      </div>
      <!-- Ajout du bouton du menu mobile qui manquait -->
      <button class="mobile-menu-btn" id="mobile-menu-btn">‚ò∞</button>
    </nav>
    
    <!-- Menu mobile -->
    <div class="mobile-nav" id="mobile-nav">
      <div class="mobile-nav-header">
        <div class="logo">Ski-Track</div>
        <button class="mobile-nav-close" id="mobile-nav-close">‚úï</button>
      </div>
      <div class="mobile-nav-links">
        <a href="../index.html">Tableau de bord</a>
        <a href="trail-inspection.html">Inspection sentier</a>
        <a href="shelter-inspection.html">Inspection abri</a>
        <a href="inspection-history.html">Historique</a>
        <a href="admin.html" class="active" id="mobile-admin-link">Administration</a>
		<a href="change-password.html" id="mobile-password-link">Mot de passe</a>
        <a href="#" id="mobile-login-link">Connexion</a>
      </div>
    </div>
  </header>
  
  <main>
    <div class="page-header">
      <h1>Panneau d'administration</h1>
      <div id="user-info">Connect√© en tant que: <span id="admin-name">Administrateur</span></div>
    </div>
    
    <div class="tabs">
      <div class="tab active" data-tab="users">Gestion des utilisateurs</div>
      <div class="tab" data-tab="data">Donn√©es du syst√®me</div>
      <div class="tab" data-tab="stats">Statistiques</div>
    </div>
    
    <div class="tab-content active" id="users-tab">
      <div class="admin-panel">
        <div class="admin-card  full-width">
          <h2 class="admin-title">Liste des utilisateurs</h2>
          
          <table id="inspectors-table">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Email</th>
                <th>T√©l√©phone</th>
				<th>R√¥le</th>
				<th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
			<tbody>
			  <!-- Les donn√©es seront charg√©es dynamiquement par JavaScript -->
			  <tr>
				<td colspan="6" style="text-align: center;">Chargement des utilisateurs...</td>
			  </tr>
			</tbody>
          </table>
            <!-- Modal de confirmation pour la suppression d'utilisateur 
          <div class="actions">
            <button id="add-user-btn" class="btn">Ajouter un inspecteur</button>
          </div>-->
        </div>
        
        <div class="admin-card full-width">
          <h2 class="admin-title">Nouvel utilisateur</h2>
          
          <form id="user-form">
            <div class="form-group">
              <label for="user-name">Nom complet</label>
              <input type="text" id="user-name" required>
            </div>
            
            <div class="form-group">
              <label for="user-email">Email</label>
              <input type="email" id="user-email" required>
            </div>
            
            <div class="form-group">
              <label for="user-phone">T√©l√©phone (optionnel)</label>
              <input type="tel" id="user-phone" placeholder="Ex: 06 12 34 56 78">
            </div>
            
            <div class="form-group">
              <label for="user-password">Mot de passe</label>
              <input type="password" id="user-password" required>
            </div>
            
			<div class="form-group">
			  <label for="user-role">R√¥le</label>
			  <select id="user-role">
				<option value="inspector">Inspecteur</option>
				<option value="admin">Administrateur</option>
			  </select>
			</div>

            <div class="form-group">
              <label for="user-status">Statut</label>
              <select id="user-status">
                <option value="active">Actif</option>
                <option value="inactive">Inactif</option>
              </select>
            </div>
            
            <div class="actions">
              <button type="button" id="cancel-user-btn" class="btn btn-secondary">Annuler</button>
              <button type="submit" class="btn btn-success">Enregistrer</button>
            </div>
          </form>
          
          <div id="user-status-message" class="status-message" style="display: none;"></div>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="data-tab">
      <div class="admin-panel">
        <div class="admin-card">
          <h2 class="admin-title">Initialisation des donn√©es</h2>
          
          <div class="admin-section">
            <h3>Sentiers</h3>
            <p>Initialiser les donn√©es des sentiers de randonn√©e alpine du Mont Orford.</p>
            <div class="actions">
              <button id="init-trails-btn" class="btn btn-warning" disabled>Initialiser les sentiers</button>
            </div>
            <div id="trails-status" class="status-message" style="display: none;"></div>
          </div>
          
          <div class="admin-section">
            <h3>Abris</h3>
            <p>Initialiser les donn√©es des abris des sommets du Mont Orford.</p>
            <div class="actions">
              <button id="init-shelters-btn" class="btn btn-warning" disabled>Initialiser les abris</button>
            </div>
            <div id="shelters-status" class="status-message" style="display: none;"></div>
          </div>
          
          <div class="admin-section">
            <h3>Donn√©es de test</h3>
            <p>Cr√©er des inspections de test pour simuler l'utilisation du syst√®me.</p>
            <div class="actions">
              <button id="create-sample-btn" class="btn" disabled>Cr√©er des donn√©es de test</button>
            </div>
            <div id="sample-status" class="status-message" style="display: none;"></div>
          </div>
        </div>
        
        <div class="admin-card">
          <h2 class="admin-title">Gestion des donn√©es</h2>
          
          <div class="admin-section">
            <h3>Sauvegarde</h3>
            <p>Exporter toutes les donn√©es du syst√®me en format JSON.</p>
            <div class="actions">
              <button id="export-data-btn" class="btn" disabled>Exporter les donn√©es</button>
            </div>
          </div>
          
          <div class="admin-section">
            <h3>R√©initialisation</h3>
            <p>Attention: Cette action supprimera toutes les donn√©es d'inspection.</p>
            <div class="actions">
              <button id="reset-inspections-btn" class="btn btn-danger" disabled>R√©initialiser les inspections</button>
            </div>
            <div id="reset-status" class="status-message" style="display: none;"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="stats-tab">
      <div class="admin-panel">
        <div class="admin-card">
          <h2 class="admin-title">Statistiques d'utilisation</h2>
          
          <div class="admin-section">
            <h3>R√©sum√© des inspections  (examples seulement... pas actif encore)</h3>
            <table>
              <tbody>
                <tr>
                  <td>Nombre total d'inspections</td>
                  <td><strong id="total-inspections">42</strong></td>
                </tr>
                <tr>
                  <td>Inspections cette semaine</td>
                  <td><strong id="week-inspections">12</strong></td>
                </tr>
                <tr>
                  <td>Inspections sentiers</td>
                  <td><strong id="trail-inspections">32</strong></td>
                </tr>
                <tr>
                  <td>Inspections abris</td>
                  <td><strong id="shelter-inspections">10</strong></td>
                </tr>
                <tr>
                  <td>Probl√®mes signal√©s non r√©solus</td>
                  <td><strong id="open-issues">7</strong></td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="admin-section">
            <h3>Activit√© des inspecteurs</h3>
            <table>
              <thead>
                <tr>
                  <th>Inspecteur</th>
                  <th>Inspections</th>
                  <th>Derni√®re activit√©</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Pierre Martin</td>
                  <td>15</td>
                  <td>14/04/2025</td>
                </tr>
                <tr>
                  <td>Sophie Legrand</td>
                  <td>18</td>
                  <td>13/04/2025</td>
                </tr>
                <tr>
                  <td>Marc Dubois</td>
                  <td>9</td>
                  <td>12/04/2025</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="admin-card">
          <h2 class="admin-title">√âtat du syst√®me</h2>
          
          <div class="admin-section">
            <h3>Utilisation Firebase</h3>
            <table>
              <tbody>
                <tr>
                  <td>Stockage utilis√©</td>
                  <td><strong id="storage-used">12.5 MB</strong></td>
                </tr>
                <tr>
                  <td>Requ√™tes Firestore ce mois</td>
                  <td><strong id="firestore-requests">1,253</strong></td>
                </tr>
                <tr>
                  <td>Utilisateurs actifs</td>
                  <td><strong id="active-users">3</strong></td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="admin-section">
            <h3>Maintenance</h3>
            <div class="actions">
              <button disabled id="clear-cache-btn" class="btn">Vider le cache</button>
              <button id="check-updates-btn" class="btn" disabled>V√©rifier les mises √† jour</button>
            </div>
            <div id="maintenance-status" class="status-message" style="display: none;"></div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Modal de confirmation pour la suppression d'utilisateur -->
  <div id="delete-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Confirmer la suppression</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <p>√ätes-vous s√ªr de vouloir supprimer cet utilisateur? Cette action est irr√©versible.</p>
        <p>Toutes les inspections associ√©es √† cet utilisateur seront conserv√©es.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary modal-cancel">Annuler</button>
        <button class="btn btn-danger" id="confirm-delete">Supprimer</button>
      </div>
    </div>
  </div>
  

<!-- Scripts Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <!-- Scripts de l'application -->
  <script src="../js/auth.js"></script>
  <script src="../js/mobile-menu.js"></script>
  <script src="../js/dashboard.js"></script>

  <script>
    // Code d'admin mis √† jour (sans la partie menu mobile)
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDcBZrwGTskM7QUvanzLTACEJ_T-55j-DA",
      authDomain: "trail-inspection.firebaseapp.com",
      projectId: "trail-inspection",
      storageBucket: "trail-inspection.firebasestorage.app",
      messagingSenderId: "415995272058",
      appId: "1:415995272058:web:dc476de8ffee052e2ad4c3",
      measurementId: "G-EBLYWBM9YB"
    };

    // Initialisation de Firebase
    firebase.initializeApp(firebaseConfig);

// Script principal pour la page d'administration
document.addEventListener('DOMContentLoaded', function() {
  // R√©f√©rences Firebase
  const auth = firebase.auth();
  const db = firebase.firestore();
  
  // ===== V√âRIFICATION DE L'AUTHENTIFICATION =====
  auth.onAuthStateChanged(function(user) {
    if (user) {
      // V√©rifier si l'utilisateur est admin
      db.collection('inspectors').doc(user.uid).get()
        .then(doc => {
          if (doc.exists && doc.data().role === 'admin') {
            // Utilisateur est admin, afficher son nom
            document.getElementById('admin-name').textContent = doc.data().name;
            
            // Charger les donn√©es
            loadInspectors();
            loadStatistics();
          } else {
            // Rediriger vers la page principale si non admin
            window.location.href = '../index.html';
          }
        })
        .catch(error => {
          console.error("Erreur lors de la v√©rification des privil√®ges:", error);
          window.location.href = '../index.html';
        });
    } else {
      // Rediriger vers la page de connexion
      window.location.href = 'login.html';
    }
  });
  
  // ===== GESTION DES ONGLETS =====
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
      // Retirer la classe active de tous les onglets
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.remove('active');
      });
      
      // Ajouter la classe active √† l'onglet cliqu√©
      this.classList.add('active');
      
      // Masquer tous les contenus d'onglet
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Afficher le contenu correspondant √† l'onglet
      const tabId = this.getAttribute('data-tab') + '-tab';
      document.getElementById(tabId).classList.add('active');
    });
  });
  
  // ===== GESTION DES INSPECTEURS =====
  // Fonction pour charger les inspecteurs
  function loadInspectors() {
    db.collection('inspectors').get()
      .then(snapshot => {
        const table = document.getElementById('inspectors-table').querySelector('tbody');
        table.innerHTML = '';
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const row = document.createElement('tr');
          
          // D√©terminer le texte et la classe CSS pour le r√¥le
          const roleText = data.role === 'admin' ? 'Administrateur' : 'Inspecteur';
          const roleClass = data.role === 'admin' ? 'role-admin' : 'role-inspector';

          row.innerHTML = `
            <td>${data.name}</td>
            <td>${data.email}</td>
            <td>${data.phone || '-'}</td>
            <td><span class="role-badge ${roleClass}">${roleText}</span></td>
            <td><span class="status-badge status-${data.status}">${data.status === 'active' ? 'Actif' : 'Inactif'}</span></td>
            <td>
              <button class="btn btn-danger btn-sm delete-user" data-id="${doc.id}">Supprimer</button>
            </td>
          `;
          
          table.appendChild(row);
        });
        
        // Ajouter les √©v√©nements apr√®s avoir cr√©√© les √©l√©ments
        setupUserActions();
      })
      .catch(error => {
        console.error("Erreur lors du chargement des inspecteurs:", error);
        showStatus('user-status-message', 'Erreur lors du chargement des inspecteurs.', 'error');
      });
  }
  
  // Configurer les actions pour les utilisateurs
  function setupUserActions() {
    // Soumission du formulaire
    document.getElementById('user-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const name = document.getElementById('user-name').value;
      const email = document.getElementById('user-email').value;
      const phone = document.getElementById('user-phone').value;
      const password = document.getElementById('user-password').value;
	  const role = document.getElementById('user-role').value;
      const status = document.getElementById('user-status').value;
      
      // D√©sactiver le bouton de soumission pour √©viter les soumissions multiples
      const submitBtn = this.querySelector('button[type="submit"]');
      if (submitBtn) submitBtn.disabled = true;

      // Cr√©er l'utilisateur dans Firebase Auth
      auth.createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          console.log("Utilisateur cr√©√© dans Auth:", userCredential.user.uid);
          
          // IMPORTANT: Ajouter les informations dans Firestore
          return db.collection('inspectors').doc(userCredential.user.uid).set({
            name: name,
            email: email,
            phone: phone || null,
            status: status,
            role: role, //'inspector', // Par d√©faut, r√¥le d'inspecteur
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        })
        .then(() => {
          console.log("Inspecteur ajout√© √† Firestore avec succ√®s");
          
          // Afficher un message de succ√®s
          showStatus('user-status-message', 'Inspecteur cr√©√© avec succ√®s!', 'success');
          
          // R√©initialiser le formulaire
          document.getElementById('user-form').reset();
          
          // R√©activer le bouton de soumission
          if (submitBtn) submitBtn.disabled = false;
          
          // Recharger la liste des inspecteurs
          loadInspectors();
        })
        .catch(error => {
          console.error("Erreur lors de la cr√©ation de l'inspecteur:", error);
          
          // Afficher l'erreur
          showStatus('user-status-message', 'Erreur: ' + error.message, 'error');
          
          // R√©activer le bouton de soumission
          if (submitBtn) submitBtn.disabled = false;
        });
    });
  
    // Bouton d'annulation du formulaire
    document.getElementById('cancel-user-btn').addEventListener('click', function() {
      document.getElementById('user-form').reset();
    });
    
    // Boutons de suppression
    document.querySelectorAll('.delete-user').forEach(button => {
      button.addEventListener('click', async function() {
        const userId = this.getAttribute('data-id');
        
        // Confirmation avant suppression
        if (confirm('√ätes-vous s√ªr de vouloir supprimer cet utilisateur? Cette action est irr√©versible.')) {
          // Afficher l'indicateur de chargement si disponible
          const loadingIndicator = document.querySelector('.loading-indicator');
          if (loadingIndicator) loadingIndicator.style.display = 'block';
          
          // D√©sactiver le bouton
          this.disabled = true;
          
          // Supprimer l'utilisateur
          const result = await deleteUser(userId);
          
          // Masquer l'indicateur de chargement
          if (loadingIndicator) loadingIndicator.style.display = 'none';
          
          // Afficher le r√©sultat
          if (result.success) {
            alert(result.message);
            
            // Recharger la liste des inspecteurs
            loadInspectors();
          } else {
            alert(result.message);
            this.disabled = false;
          }
        }
      });
    });
    
    // Gestion de la modal
    const closeModalBtn = document.querySelector('.modal-close');
    const cancelModalBtn = document.querySelector('.modal-cancel');
    
    if (closeModalBtn) {
      closeModalBtn.addEventListener('click', function() {
        document.getElementById('delete-modal').style.display = 'none';
      });
    }
    
    if (cancelModalBtn) {
      cancelModalBtn.addEventListener('click', function() {
        document.getElementById('delete-modal').style.display = 'none';
      });
    }
  }

  // ===== GESTION DES STATISTIQUES =====
  function loadStatistics() {
    // Dans une impl√©mentation r√©elle, charger les statistiques depuis Firestore
    console.log('Chargement des statistiques...');
  }
  
  // ===== INITIALISATION DES DONN√âES =====
  // Fonction pour initialiser les donn√©es des sentiers
  document.getElementById('init-trails-btn').addEventListener('click', function() {
  // Don't proceed if the button is disabled
  if (this.disabled) {
    e.preventDefault();
    return;
  }
  if (confirm('√ätes-vous s√ªr de vouloir initialiser les donn√©es des sentiers? Cela √©crasera toutes les donn√©es existantes.')) {
      showStatus('trails-status', 'Initialisation en cours...', 'info');
      
      // Les donn√©es des sentiers
      const trailsData = [
        {
          id: 'trail_1',
          name: "La tortue",
          length: 1.1,
          difficulty: "easy",
          description: "Sentier facile id√©al pour d√©butants",
          coordinates: { top: 394, left: 450 }
        },
        {
          id: 'trail_2',
          name: "Trac√© du lynx",
          length: 0.6,
          difficulty: "easy",
          description: "Court sentier avec peu de d√©nivel√©",
          coordinates: { top: 323, left: 210 }
        },
        {
          id: 'trail_3',
          name: "Adams",
          length: 0.6,
          difficulty: "easy",
          description: "Sentier familial accessible",
          coordinates: { top: 520, left: 420 }
        },
        {
          id: 'trail_4',
          name: "Le renard",
          length: 2.4,
          difficulty: "easy",
          description: "Sentier plus long mais avec pente douce",
          coordinates: { top: 430, left: 45 }
        },
        {
          id: 'trail_5',
          name: "Le li√®vre",
          length: 1.3,
          difficulty: "medium",
          description: "Sentier interm√©diaire avec quelques pentes",
          coordinates: { top: 145, left: 283 }
        },
        {
          id: 'trail_6',
          name: "Le Campagnol",
          length: 1.5,
          difficulty: "hard",
          description: "Sentier difficile pour randonneurs exp√©riment√©s",
          coordinates: { top: 20, left: 426 }
        },
        {
          id: 'trail_7',
          name: "L'Hermine",
          length: 1.8,
          difficulty: "medium",
          description: "Sentier interm√©diaire avec belle vue",
          coordinates: { top: 372, left: 530 }
        },
        {
          id: 'trail_8',
          name: "L'Alouette",
          length: 2.4,
          difficulty: "medium",
          description: "Sentier avec d√©nivel√© mod√©r√©",
          coordinates: { top: 410, left: 661 }
        },
        {
          id: 'trail_9',
          name: "L'Urubu",
          length: 1.2,
          difficulty: "hard",
          description: "Sentier technique et escarp√©",
          coordinates: { top: 504, left: 255 }
        },
        {
          id: 'trail_10',
          name: "La Carcajou",
          length: 0.8,
          difficulty: "hard",
          description: "Court sentier mais tr√®s exigeant",
          coordinates: { top: 470, left: 288 }
        },
        {
          id: 'trail_11',
          name: "La Mille-Pattes",
          length: 1.5,
          difficulty: "hard",
          description: "Sentier avec plusieurs segments techniques",
          coordinates: { top: 308, left: 518 }
        }
      ];
      
      // Initialiser les donn√©es des sentiers
      const batch = db.batch();
      
      // D'abord, supprimer les donn√©es existantes
      db.collection('trails').get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            batch.delete(doc.ref);
          });
          
          // Ensuite, ajouter les nouvelles donn√©es
          trailsData.forEach(trail => {
            const docRef = db.collection('trails').doc(trail.id);
            batch.set(docRef, {
              name: trail.name,
              length: trail.length,
              difficulty: trail.difficulty,
              description: trail.description,
              coordinates: trail.coordinates,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          });
          
          // Ex√©cuter le batch
          return batch.commit();
        })
        .then(() => {
          showStatus('trails-status', 'Donn√©es des sentiers initialis√©es avec succ√®s!', 'success');
        })
        .catch(error => {
          console.error("Erreur lors de l'initialisation des sentiers:", error);
          showStatus('trails-status', 'Erreur: ' + error.message, 'error');
        });
    }
  });
  
  // Fonction pour initialiser les donn√©es des abris
  document.getElementById('init-shelters-btn').addEventListener('click', function() {
  // Don't proceed if the button is disabled
  if (this.disabled) {
    e.preventDefault();
    return;
  }
    if (confirm('√ätes-vous s√ªr de vouloir initialiser les donn√©es des abris? Cela √©crasera toutes les donn√©es existantes.')) {
      showStatus('shelters-status', 'Initialisation en cours...', 'info');
      
      // Les donn√©es des abris
      const sheltersData = [
        {
          id: 'shelter_1',
          name: "Mont Giroux",
          altitude: 650,
          coordinates: { top: 457, left: 134 }
        },
        {
          id: 'shelter_2',
          name: "Mont Orford",
          altitude: 850,
          coordinates: { top: 41, left: 470 }
        },
        {
          id: 'shelter_3',
          name: "Mont Alfred-Desrochers",
          altitude: 615,
          coordinates: { top: 176, left: 621 }
        }
      ];
      
      // Initialiser les donn√©es des abris
      const batch = db.batch();
      
      // D'abord, supprimer les donn√©es existantes
      db.collection('shelters').get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            batch.delete(doc.ref);
          });
          
          // Ensuite, ajouter les nouvelles donn√©es
          sheltersData.forEach(shelter => {
            const docRef = db.collection('shelters').doc(shelter.id);
            batch.set(docRef, {
              name: shelter.name,
              altitude: shelter.altitude,
              coordinates: shelter.coordinates,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          });
          
          // Ex√©cuter le batch
          return batch.commit();
        })
        .then(() => {
          showStatus('shelters-status', 'Donn√©es des abris initialis√©es avec succ√®s!', 'success');
        })
        .catch(error => {
          console.error("Erreur lors de l'initialisation des abris:", error);
          showStatus('shelters-status', 'Erreur: ' + error.message, 'error');
        });
    }
  });
  
  // ===== GESTION DES DONN√âES DE TEST ET R√âINITIALISATION =====
  // Fonction pour cr√©er des donn√©es de test
  document.getElementById('create-sample-btn').addEventListener('click', function() {
  // Don't proceed if the button is disabled
  if (this.disabled) {
    e.preventDefault();
    return;
  }
    if (confirm('Voulez-vous cr√©er des donn√©es d\'inspection de test? Cela ajoutera plusieurs inspections fictives.')) {
      showStatus('sample-status', 'Cr√©ation des donn√©es de test en cours...', 'info');
      
      // Dans une impl√©mentation r√©elle, cr√©er des inspections de test
      setTimeout(() => {
        showStatus('sample-status', 'Donn√©es de test cr√©√©es avec succ√®s!', 'success');
      }, 1500);
    }
  });
  
  // Fonction pour r√©initialiser les inspections
  document.getElementById('reset-inspections-btn').addEventListener('click', function() {
  // Don't proceed if the button is disabled
  if (this.disabled) {
    e.preventDefault();
    return;
  }
    if (confirm('ATTENTION: Voulez-vous vraiment supprimer TOUTES les inspections? Cette action est irr√©versible.')) {
      showStatus('reset-status', 'R√©initialisation en cours...', 'warning');
      
      // Supprimer toutes les inspections
      const trailBatch = db.batch();
      const shelterBatch = db.batch();
      
      // Supprimer les inspections de sentiers
      db.collection('trail_inspections').get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            trailBatch.delete(doc.ref);
          });
          return trailBatch.commit();
        })
        .then(() => {
          // Supprimer les inspections d'abris
          return db.collection('shelter_inspections').get();
        })
        .then(snapshot => {
          snapshot.forEach(doc => {
            shelterBatch.delete(doc.ref);
          });
          return shelterBatch.commit();
        })
        .then(() => {
          showStatus('reset-status', 'Toutes les inspections ont √©t√© supprim√©es.', 'success');
          
          // Mettre √† jour les statistiques
          loadStatistics();
        })
        .catch(error => {
          console.error("Erreur lors de la r√©initialisation:", error);
          showStatus('reset-status', 'Erreur: ' + error.message, 'error');
});
    }
  });
  
  // ===== AUTRES FONCTIONNALIT√âS =====
  // Fonction d'exportation des donn√©es
  document.getElementById('export-data-btn').addEventListener('click', function() {
  // Don't proceed if the button is disabled
  if (this.disabled) {
    e.preventDefault();
    return;
  }
    // Dans une impl√©mentation r√©elle, exporter toutes les donn√©es au format JSON
    alert('Fonctionnalit√© d\'exportation en cours de d√©veloppement.');
  });
  
  // Fonctions de maintenance
  document.getElementById('clear-cache-btn').addEventListener('click', function() {
  // Don't proceed if the button is disabled
  if (this.disabled) {
    e.preventDefault();
    return;
  }
    // Simuler le nettoyage du cache
    showStatus('maintenance-status', 'Nettoyage du cache en cours...', 'info');
    
    setTimeout(() => {
      showStatus('maintenance-status', 'Cache nettoy√© avec succ√®s!', 'success');
    }, 1000);
  });
  
  document.getElementById('check-updates-btn').addEventListener('click', function() {
  // Don't proceed if the button is disabled
  if (this.disabled) {
    e.preventDefault();
    return;
  }
    // Simuler la v√©rification des mises √† jour
    showStatus('maintenance-status', 'V√©rification des mises √† jour...', 'info');
    
    setTimeout(() => {
      showStatus('maintenance-status', 'Votre syst√®me est √† jour!', 'success');
    }, 1500);
  });
  
  // Fonction de d√©connexion
  if (document.getElementById('logout-link')) {
    document.getElementById('logout-link').addEventListener('click', function(e) {
      e.preventDefault();
      
      auth.signOut()
        .then(() => {
          window.location.href = 'login.html';
        })
        .catch(error => {
          console.error("Erreur lors de la d√©connexion:", error);
        });
    });
  }
  
  // ===== FONCTIONS UTILITAIRES =====
  // Fonction utilitaire pour afficher les messages de statut
  function showStatus(elementId, message, type) {
    const statusElement = document.getElementById(elementId);
    if (!statusElement) return;
    
    statusElement.textContent = message;
    statusElement.className = 'status-message status-' + type;
    statusElement.style.display = 'block';
    
    // Faire dispara√Ætre le message apr√®s un certain temps, sauf pour les erreurs
    if (type !== 'error') {
      setTimeout(() => {
        statusElement.style.display = 'none';
      }, 5000);
    }
  }

  /**
   * Supprime un utilisateur et ses donn√©es associ√©es
   * @param {string} userId - L'ID de l'utilisateur √† supprimer
   */
  async function deleteUser(userId) {
    try {
      // R√©cup√©rer les informations de l'utilisateur √† supprimer
      const userDoc = await db.collection('inspectors').doc(userId).get();
      
      if (!userDoc.exists) {
        throw new Error("Utilisateur non trouv√© dans la base de donn√©es");
      }
      
      // 1. Supprimer les donn√©es de l'utilisateur dans Firestore
      await db.collection('inspectors').doc(userId).delete();
      
      // 2. Supprimer les inspections associ√©es (optionnel)
      // Pour les inspections de sentiers
      const trailInspectionsSnapshot = await db.collection('trail_inspections')
        .where('inspector_id', '==', userId)
        .get();
      
      // Utiliser un batch pour supprimer plusieurs documents efficacement
      if (!trailInspectionsSnapshot.empty) {
        const trailBatch = db.batch();
        trailInspectionsSnapshot.forEach(doc => {
          trailBatch.delete(doc.ref);
        });
        await trailBatch.commit();
      }
      
      // Pour les inspections d'abris
      const shelterInspectionsSnapshot = await db.collection('shelter_inspections')
        .where('inspector_id', '==', userId)
        .get();
      
      if (!shelterInspectionsSnapshot.empty) {
        const shelterBatch = db.batch();
        shelterInspectionsSnapshot.forEach(doc => {
          shelterBatch.delete(doc.ref);
        });
        await shelterBatch.commit();
      }
      
      console.log("Utilisateur supprim√© de Firestore avec succ√®s");
      
      return {
        success: true,
        message: "Donn√©es utilisateur supprim√©es. Veuillez contacter l'administrateur pour compl√©ter la suppression du compte."
      };
    } catch (error) {
      console.error("Erreur lors de la suppression de l'utilisateur:", error);
      
      return {
        success: false,
        message: "Erreur lors de la suppression: " + error.message
      };
    }
  }

  console.log('Script d\'administration initialis√©');
});


  </script>


</body>
</html>