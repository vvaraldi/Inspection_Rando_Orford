<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ski-Track - Historique des inspections</title>
  <link rel="stylesheet" href="../css/styles.css">
</head>

<script>
  window.onerror = function(message, source, lineno, colno, error) {
    console.log("Erreur JavaScript: ", message, "√† la ligne", lineno, "colonne", colno);
    console.log("Source:", source);
    console.log("Erreur compl√®te:", error);
    
    // Afficher le contenu en cas d'erreur
    document.getElementById('loading').style.display = 'none';
    document.getElementById('main-content').style.display = 'block';
    
    return true; // Emp√™che l'affichage de l'erreur dans la console
  };
</script>

<body>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèîÔ∏è</text></svg>">
  <header>
  <nav>
    <div class="logo">Ski-Track</div>
    <!-- Menu desktop -->
    <div class="nav-links">
		<a href="../index.html">Tableau de bord</a>
		<a href="trail-inspection.html">Inspection sentier</a>
		<a href="shelter-inspection.html">Inspection abri</a>
		<a href="inspection-history.html" class="active">Historique</a>
		<a href="admin.html" id="admin-link" style="display: none;">Administration</a>
		<a href="change-password.html">Mot de passe</a>
		<a href="#" id="login-link">Connexion</a>
    </div>
    <!-- Bouton du menu mobile -->
    <button class="mobile-menu-btn" id="mobile-menu-btn">‚ò∞</button>
  </nav>
  
  <!-- Menu mobile -->
  <div class="mobile-nav" id="mobile-nav">
    <div class="mobile-nav-header">
      <div class="logo">Ski-Track</div>
      <button class="mobile-nav-close" id="mobile-nav-close">‚úï</button>
    </div>
    <div class="mobile-nav-links">
      <a href="../index.html">Tableau de bord</a>
      <a href="trail-inspection.html">Inspection sentier</a>
      <a href="shelter-inspection.html">Inspection abri</a>
      <a href="inspection-history.html" class="active">Historique</a>
      <a href="admin.html" id="mobile-admin-link" style="display: none;">Administration</a>
	  <a href="change-password.html" id="mobile-password-link">Mot de passe</a>
      <a href="#" id="mobile-login-link">Connexion</a>
    </div>
  </div>
  </header>

  <!-- Indicateur de chargement principal -->
  <div id="loading">
    <div style="text-align: center;">
      <div class="loading-spinner"></div>
      <p>V√©rification de l'authentification...</p>
    </div>
  </div>
  
  <!-- Contenu principal - cach√© initialement -->
  <div id="main-content" style="display: none;">
    <main>
      <div class="page-header">
        <h1>Historique des inspections</h1>
        
        <div class="export-dropdown">
          <button class="btn btn-secondary">Exporter <span>‚ñº</span></button>
          <div class="export-dropdown-content">
            <a href="#" class="export-dropdown-item" id="export-pdf">Exporter en PDF</a>
            <a href="#" class="export-dropdown-item" id="export-csv">Exporter en CSV</a>
            <a href="#" class="export-dropdown-item" id="export-excel">Exporter en Excel</a>
          </div>
        </div>
      </div>
      
      <div class="filter-container">
        <div class="filter-row">
          <div class="filter-group">
            <label class="filter-label" for="period-filter">P√©riode</label>
            <select class="filter-control" id="period-filter">
              <option value="all">Toutes les dates</option>
              <option value="today">Aujourd'hui</option>
              <option value="week">Cette semaine</option>
              <option value="month">Ce mois</option>
              <option value="custom">P√©riode personnalis√©e</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label" for="type-filter">Type</label>
            <select class="filter-control" id="type-filter">
              <option value="all">Tous les types</option>
              <option value="trail">Sentiers</option>
              <option value="shelter">Abris</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label" for="location-filter">Sentier/Abri</label>
            <select class="filter-control" id="location-filter">
              <option value="all">Tous</option>
              <!-- Les options seront charg√©es dynamiquement -->
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label" for="status-filter">√âtat</label>
            <select class="filter-control" id="status-filter">
              <option value="all">Tous les √©tats</option>
              <option value="good">Bon</option>
              <option value="warning">Attention</option>
              <option value="critical">Critique</option>
            </select>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="inspector-filter">Inspecteur</label>
            <select class="filter-control" id="inspector-filter">
              <option value="all">Tous les inspecteurs</option>
              <!-- Les options seront charg√©es dynamiquement -->
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Recherche</label>
            <div class="search-box">
              <span class="search-icon">üîç</span>
              <input type="text" class="search-input" id="search-input" placeholder="Rechercher...">
            </div>
          </div>
        </div>
        
        <div class="filter-buttons">
          <button class="btn btn-secondary" id="reset-filters">R√©initialiser</button>
          <button class="btn" id="apply-filters">Appliquer</button>
        </div>
      </div>
      
      <div class="table-container" style="position: relative;">
        <!-- Indicateur de chargement pour le tableau -->
        <div id="loading-overlay" style="display: none;">
          <div class="loading-spinner"></div>
        </div>

        <table>
          <thead>
            <tr>
              <th data-sort="date">Date</th>
              <th data-sort="type">Type</th>
              <th data-sort="location">Sentier/Abri</th>
              <th data-sort="inspector">Inspecteur</th>
              <th data-sort="condition">√âtat</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="inspections-table">
            <!-- Les donn√©es seront charg√©es dynamiquement -->
            <tr>
              <td colspan="6" style="text-align: center;">Chargement des donn√©es...</td>
            </tr>
          </tbody>
        </table>
        
        <div class="pagination">
          <div class="pagination-info" id="pagination-info">
            Affichage de 1 √† 10 sur 0 entr√©es
          </div>
          
          <div class="pagination-buttons" id="pagination-buttons">
            <button class="page-btn" disabled>&laquo;</button>
            <button class="page-btn active">1</button>
            <button class="page-btn">&raquo;</button>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Modal de d√©tails d'inspection -->
  <div id="inspection-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">D√©tails de l'inspection</h2>
        <button class="modal-close">&times;</button>
      </div>
      
      <div class="modal-body" id="modal-content">
        <!-- Le contenu de la modal sera g√©n√©r√© dynamiquement -->
      </div>
    </div>
  </div>
  
<!-- Scripts Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

  
  <!-- Scripts de l'application -->
  <script src="../js/auth.js"></script>
  <script src="../js/mobile-menu.js"></script>


  <script>
    // Variables pour la pagination et le tri
    let currentPage = 1;
    const pageSize = 10;
    let totalItems = 0;
    let allInspections = [];
    let filteredInspections = [];
    let sortField = 'date';
    let sortDirection = 'desc';
    let currentFilters = {
      period: 'all',
      type: 'all',
      location: 'all',
      status: 'all',
      inspector: 'all',
      search: ''
    };

    // √âl√©ments du DOM
    const loadingOverlay = document.getElementById('loading-overlay');
    const inspectionsTable = document.getElementById('inspections-table');
    const paginationInfo = document.getElementById('pagination-info');
    const paginationButtons = document.getElementById('pagination-buttons');
    const modal = document.getElementById('inspection-modal');
    
    // R√©f√©rence √† Storage
let storage = null;
try {
  if (typeof firebase !== 'undefined' && firebase.storage) {
    storage = firebase.storage();
  } else {
    console.warn("Firebase Storage n'est pas disponible");
  }
} catch (error) {
  console.error("Erreur lors de l'initialisation de Firebase Storage:", error);
}
    
   // Initialisation lors du chargement du document
    document.addEventListener('DOMContentLoaded', function() {
      // Configurer les filtres
      setupFilters();
      
      // Configurer le tri
      setupTableSorting();
      
      // Configurer la pagination
      setupPagination();
      
      // Configurer la modal
      setupModal();
      
      // Configurer l'exportation
      setupExport();
    });
	
	// D√©clarer loadInspectionHistory comme une fonction globale pour qu'elle soit accessible depuis auth.js
	window.loadInspectionHistory = function() {
	  try {
		showLoading(true);
		
		// Charger les donn√©es des emplacements pour les filtres
		loadLocationsForFilter().then(() => {
		  // Charger les donn√©es des inspecteurs pour les filtres
		  return loadInspectorsForFilter();
		}).then(() => {
		  // Charger toutes les inspections
		  return loadAllInspections();
		}).then(() => {
		  // Appliquer les filtres par d√©faut
		  applyFilters();
		  showLoading(false);
		}).catch(error => {
		  console.error("Erreur lors du chargement de l'historique:", error);
		  showLoading(false);
		  // Afficher un message d'erreur
		  const table = document.getElementById('inspections-table');
		  if (table) {
			table.innerHTML = `
			  <tr>
				<td colspan="6" style="text-align: center; color: #e02424;">
				  Erreur lors du chargement des donn√©es. Veuillez r√©essayer.
				</td>
			  </tr>
			`;
		  }
		});
	  } catch (error) {
		console.error("Erreur lors du chargement de l'historique:", error);
		showLoading(false);
	  }
	};

    // Fonction appel√©e apr√®s l'authentification r√©ussie
    async function loadInspectionHistory() {
      try {
        showLoading(true);
        
        // Charger les donn√©es des emplacements pour les filtres
        await loadLocationsForFilter();
        
        // Charger les donn√©es des inspecteurs pour les filtres
        await loadInspectorsForFilter();
        
        // Charger toutes les inspections
        await loadAllInspections();
        
        // Appliquer les filtres par d√©faut
        applyFilters();
        
        showLoading(false);
      } catch (error) {
        console.error("Erreur lors du chargement de l'historique:", error);
        showLoading(false);
        // Afficher un message d'erreur
        inspectionsTable.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; color: #e02424;">
              Erreur lors du chargement des donn√©es. Veuillez r√©essayer.
            </td>
          </tr>
        `;
      }
    }

    // Charger les donn√©es des sentiers et abris pour le filtre
    async function loadLocationsForFilter() {
      try {
        const locationFilter = document.getElementById('location-filter');
        locationFilter.innerHTML = '<option value="all">Tous</option>';
        
        // Groupe pour les sentiers
        const trailOptgroup = document.createElement('optgroup');
        trailOptgroup.label = "Sentiers";
        
        // R√©cup√©rer les sentiers
        const trailsSnapshot = await db.collection('trails').orderBy('name').get();
        trailsSnapshot.forEach(doc => {
          const trail = doc.data();
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = `${trail.name}`;
          trailOptgroup.appendChild(option);
        });
        
        // Groupe pour les abris
        const shelterOptgroup = document.createElement('optgroup');
        shelterOptgroup.label = "Abris";
        
        // R√©cup√©rer les abris
        const sheltersSnapshot = await db.collection('shelters').orderBy('name').get();
        sheltersSnapshot.forEach(doc => {
          const shelter = doc.data();
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = `${shelter.name}`;
          shelterOptgroup.appendChild(option);
        });
        
        // Ajouter les groupes au select
        locationFilter.appendChild(trailOptgroup);
        locationFilter.appendChild(shelterOptgroup);
      } catch (error) {
        console.error("Erreur lors du chargement des emplacements:", error);
      }
    }

    // Charger les donn√©es des inspecteurs pour le filtre
    async function loadInspectorsForFilter() {
      try {
        const inspectorFilter = document.getElementById('inspector-filter');
        inspectorFilter.innerHTML = '<option value="all">Tous les inspecteurs</option>';
        
        // R√©cup√©rer les inspecteurs
        const inspectorsSnapshot = await db.collection('inspectors').orderBy('name').get();
        inspectorsSnapshot.forEach(doc => {
          const inspector = doc.data();
          if (inspector.status === 'active') {
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = inspector.name;
            inspectorFilter.appendChild(option);
          }
        });
      } catch (error) {
        console.error("Erreur lors du chargement des inspecteurs:", error);
      }
    }

    // Charger toutes les inspections
    async function loadAllInspections() {
      allInspections = [];
      
      // R√©cup√©rer les inspections de sentiers
      const trailInspections = await loadTrailInspections();
      
      // R√©cup√©rer les inspections d'abris
      const shelterInspections = await loadShelterInspections();
      
      // Combiner les deux types d'inspection
      allInspections = [...trailInspections, ...shelterInspections];
      
      // Trier par date d√©croissante (plus r√©cent en premier)
      allInspections.sort((a, b) => b.date.getTime() - a.date.getTime());
      
      return allInspections;
    }

    // Charger les inspections de sentiers
    async function loadTrailInspections() {
      const trailInspections = [];
      
      try {
        // R√©cup√©rer toutes les inspections de sentiers
        const snapshot = await db.collection('trail_inspections')
          .orderBy('date', 'desc')
          .get();
        
        // Cr√©er une map des sentiers pour acc√©der rapidement aux noms
        const trailsMap = await getTrailsMap();
        
        // Cr√©er une map des inspecteurs pour acc√©der rapidement aux noms
        const inspectorsMap = await getInspectorsMap();
        
        for (const doc of snapshot.docs) {
          const data = doc.data();
          const trailId = data.trail_id;
          const inspectorId = data.inspector_id;
          
          // Obtenir les informations du sentier
          const trail = trailsMap.get(trailId) || { name: 'Sentier inconnu' };
          
          // Obtenir les informations de l'inspecteur
          const inspector = inspectorsMap.get(inspectorId) || { name: 'Inspecteur inconnu' };
          
          trailInspections.push({
            id: doc.id,
            type: 'trail',
            date: data.date.toDate(),
            location: trail.name,
            locationId: trailId,
            inspector: inspector.name,
            inspectorId: inspectorId,
            condition: data.condition || 'not-inspected',
            issues: data.issues || [],
            comments: data.comments || '',
            photos: data.photos || [],
            rawData: data
          });
        }
      } catch (error) {
        console.error("Erreur lors du chargement des inspections de sentiers:", error);
      }
      
      return trailInspections;
    }

    // Charger les inspections d'abris
    async function loadShelterInspections() {
      const shelterInspections = [];
      
      try {
        // R√©cup√©rer toutes les inspections d'abris
        const snapshot = await db.collection('shelter_inspections')
          .orderBy('date', 'desc')
          .get();
        
        // Cr√©er une map des abris pour acc√©der rapidement aux noms
        const sheltersMap = await getSheltersMap();
        
        // Cr√©er une map des inspecteurs pour acc√©der rapidement aux noms
        const inspectorsMap = await getInspectorsMap();
        
        for (const doc of snapshot.docs) {
          const data = doc.data();
          const shelterId = data.shelter_id;
          const inspectorId = data.inspector_id;
          
          // Obtenir les informations de l'abri
          const shelter = sheltersMap.get(shelterId) || { name: 'Abri inconnu' };
          
          // Obtenir les informations de l'inspecteur
          const inspector = inspectorsMap.get(inspectorId) || { name: 'Inspecteur inconnu' };
          
          shelterInspections.push({
            id: doc.id,
            type: 'shelter',
            date: data.date.toDate(),
            location: shelter.name,
            locationId: shelterId,
            inspector: inspector.name,
            inspectorId: inspectorId,
            condition: data.condition || 'not-inspected',
            issues: data.issues || [],
            comments: data.comments || '',
            photos: data.photos || [],
            rawData: data
          });
        }
      } catch (error) {
        console.error("Erreur lors du chargement des inspections d'abris:", error);
      }
      
      return shelterInspections;
    }

    // Obtenir une map des sentiers
    async function getTrailsMap() {
      const trailsMap = new Map();
      
      try {
        const snapshot = await db.collection('trails').get();
        snapshot.forEach(doc => {
          trailsMap.set(doc.id, doc.data());
        });
      } catch (error) {
        console.error("Erreur lors du chargement des sentiers:", error);
      }
      
      return trailsMap;
    }

    // Obtenir une map des abris
    async function getSheltersMap() {
      const sheltersMap = new Map();
      
      try {
        const snapshot = await db.collection('shelters').get();
        snapshot.forEach(doc => {
          sheltersMap.set(doc.id, doc.data());
        });
      } catch (error) {
        console.error("Erreur lors du chargement des abris:", error);
      }
      
      return sheltersMap;
    }

    // Obtenir une map des inspecteurs
    async function getInspectorsMap() {
      const inspectorsMap = new Map();
      
      try {
        const snapshot = await db.collection('inspectors').get();
        snapshot.forEach(doc => {
          inspectorsMap.set(doc.id, doc.data());
        });
      } catch (error) {
        console.error("Erreur lors du chargement des inspecteurs:", error);
      }
      
      return inspectorsMap;
    }

    // Configurer les filtres
    function setupFilters() {
      // √âv√©nements pour les filtres
      document.getElementById('reset-filters').addEventListener('click', resetFilters);
      document.getElementById('apply-filters').addEventListener('click', applyFilters);
      
      // √âv√©nement de recherche
      document.getElementById('search-input').addEventListener('input', function() {
        // Appliquer la recherche apr√®s un court d√©lai pour √©viter trop de requ√™tes
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(() => {
          currentFilters.search = this.value.trim().toLowerCase();
          applyFilters();
        }, 300);
      });
    }

    // R√©initialiser tous les filtres
    function resetFilters() {
      document.getElementById('period-filter').value = 'all';
      document.getElementById('type-filter').value = 'all';
      document.getElementById('location-filter').value = 'all';
      document.getElementById('status-filter').value = 'all';
      document.getElementById('inspector-filter').value = 'all';
      document.getElementById('search-input').value = '';
      
      currentFilters = {
        period: 'all',
        type: 'all',
        location: 'all',
        status: 'all',
        inspector: 'all',
        search: ''
      };
      
      applyFilters();
    }

    // Appliquer les filtres
    function applyFilters() {
      showLoading(true);
      
      // R√©cup√©rer les valeurs des filtres
      currentFilters.period = document.getElementById('period-filter').value;
      currentFilters.type = document.getElementById('type-filter').value;
      currentFilters.location = document.getElementById('location-filter').value;
      currentFilters.status = document.getElementById('status-filter').value;
      currentFilters.inspector = document.getElementById('inspector-filter').value;
      currentFilters.search = document.getElementById('search-input').value.trim().toLowerCase();
      
      // Filtrer les inspections
      filteredInspections = allInspections.filter(inspection => {
        // Filtrer par p√©riode
        if (currentFilters.period !== 'all') {
          const now = new Date();
          const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          
          switch (currentFilters.period) {
            case 'today':
              if (inspection.date < today) return false;
              break;
            case 'week':
              const weekAgo = new Date(now);
              weekAgo.setDate(weekAgo.getDate() - 7);
              if (inspection.date < weekAgo) return false;
              break;
            case 'month':
              const monthAgo = new Date(now);
              monthAgo.setMonth(monthAgo.getMonth() - 1);
              if (inspection.date < monthAgo) return false;
              break;
          }
        }
        
        // Filtrer par type
        if (currentFilters.type !== 'all' && inspection.type !== currentFilters.type) {
          return false;
        }
        
        // Filtrer par emplacement
        if (currentFilters.location !== 'all' && inspection.locationId !== currentFilters.location) {
          return false;
        }
        
        // Filtrer par √©tat
        if (currentFilters.status !== 'all' && inspection.condition !== currentFilters.status) {
          return false;
        }
        
        // Filtrer par inspecteur
        if (currentFilters.inspector !== 'all' && inspection.inspectorId !== currentFilters.inspector) {
          return false;
        }
        
        // Filtrer par recherche textuelle
        if (currentFilters.search) {
          const searchTerms = currentFilters.search.split(' ');
          
          // V√©rifier si tous les termes sont pr√©sents
          return searchTerms.every(term => {
            return (
              inspection.location.toLowerCase().includes(term) ||
              inspection.inspector.toLowerCase().includes(term) ||
              inspection.comments.toLowerCase().includes(term) ||
              inspection.issues.some(issue => issue.toLowerCase().includes(term))
            );
          });
        }
        
        return true;
      });
      
      // Appliquer le tri actuel
      sortInspections(sortField, sortDirection);
      
      // Mettre √† jour la pagination
      totalItems = filteredInspections.length;
      currentPage = 1;
      updatePagination();
      
      // Afficher les r√©sultats
      displayInspections();
      
      showLoading(false);
    }

    // Configurer le tri des colonnes
    function setupTableSorting() {
      document.querySelectorAll('th[data-sort]').forEach(header => {
        header.addEventListener('click', function() {
          const field = this.getAttribute('data-sort');
          
          // Inverser la direction si on clique sur la colonne d√©j√† tri√©e
          if (field === sortField) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            sortField = field;
            sortDirection = 'asc';
          }
          
          // Appliquer le tri
          sortInspections(sortField, sortDirection);
          
          // Mettre √† jour l'affichage
          displayInspections();
          
          // Mettre √† jour l'indicateur visuel de tri
          document.querySelectorAll('th[data-sort]').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
          });
          this.classList.add(`sort-${sortDirection}`);
        });
      });
    }

    // Trier les inspections
    function sortInspections(field, direction) {
      filteredInspections.sort((a, b) => {
        let valueA, valueB;
        
        switch (field) {
          case 'date':
            valueA = a.date.getTime();
            valueB = b.date.getTime();
            break;
          case 'type':
            valueA = a.type;
            valueB = b.type;
            break;
          case 'location':
            valueA = a.location;
            valueB = b.location;
            break;
          case 'inspector':
            valueA = a.inspector;
            valueB = b.inspector;
            break;
          case 'condition':
            // Ordre personnalis√© pour les conditions
            const order = { 'critical': 0, 'warning': 1, 'good': 2, 'not-inspected': 3 };
            valueA = order[a.condition];
            valueB = order[b.condition];
            break;
          default:
            valueA = a.date.getTime();
            valueB = b.date.getTime();
        }
        
        // Comparer les valeurs en tenant compte de la direction du tri
        if (direction === 'asc') {
          return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
        } else {
          return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
        }
      });
    }

    // Configurer la pagination
    function setupPagination() {
      document.getElementById('pagination-buttons').addEventListener('click', function(e) {
        if (e.target.classList.contains('page-btn')) {
          // D√©terminer la page √† afficher
          if (e.target.textContent === '¬´') {
            // Bouton pr√©c√©dent
            if (currentPage > 1) {
              currentPage--;
            }
          } else if (e.target.textContent === '¬ª') {
            // Bouton suivant
            if (currentPage < Math.ceil(totalItems / pageSize)) {
              currentPage++;
            }
          } else {
            // Num√©ro de page
            currentPage = parseInt(e.target.textContent);
          }
          
          // Mettre √† jour la pagination et l'affichage
          updatePagination();
          displayInspections();
        }
      });
    }

    // Mettre √† jour la pagination
    function updatePagination() {
      const totalPages = Math.ceil(totalItems / pageSize);
      const startItem = (currentPage - 1) * pageSize + 1;
      const endItem = Math.min(startItem + pageSize - 1, totalItems);
      
      // Mettre √† jour l'info de pagination
      paginationInfo.textContent = `Affichage de ${totalItems > 0 ? startItem : 0} √† ${endItem} sur ${totalItems} entr√©es`;
      
      // G√©n√©rer les boutons de pagination
      let paginationHTML = '';
      
      // Bouton pr√©c√©dent
      paginationHTML += `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''}>&laquo;</button>`;
      
      // Pages
      if (totalPages <= 7) {
        // Afficher toutes les pages si moins de 7
        for (let i = 1; i <= totalPages; i++) {
          paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}">${i}</button>`;
        }
      } else {
        // Afficher un nombre limit√© de pages avec ellipsis
        if (currentPage <= 3) {
          // Pr√®s du d√©but
          for (let i = 1; i <= 5; i++) {
            paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}">${i}</button>`;
          }
          paginationHTML += `<span class="page-ellipsis">...</span>`;
          paginationHTML += `<button class="page-btn">${totalPages}</button>`;
        } else if (currentPage >= totalPages - 2) {
          // Pr√®s de la fin
          paginationHTML += `<button class="page-btn">1</button>`;
          paginationHTML += `<span class="page-ellipsis">...</span>`;
          for (let i = totalPages - 4; i <= totalPages; i++) {
            paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}">${i}</button>`;
          }
        } else {
          // Au milieu
          paginationHTML += `<button class="page-btn">1</button>`;
          paginationHTML += `<span class="page-ellipsis">...</span>`;
          for (let i = currentPage - 1; i <= currentPage + 1; i++) {
            paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}">${i}</button>`;
          }
          paginationHTML += `<span class="page-ellipsis">...</span>`;
          paginationHTML += `<button class="page-btn">${totalPages}</button>`;
        }
      }
      
      // Bouton suivant
      paginationHTML += `<button class="page-btn" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}>&raquo;</button>`;
      
      // Mettre √† jour les boutons
      paginationButtons.innerHTML = paginationHTML;
    }

    // Afficher les inspections pour la page actuelle
    function displayInspections() {
      // Calculer les limites de la page actuelle
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = startIndex + pageSize;
      const pageInspections = filteredInspections.slice(startIndex, endIndex);
      
      // Vider le tableau
      inspectionsTable.innerHTML = '';
      
      // Afficher un message si aucune inspection
      if (pageInspections.length === 0) {
        inspectionsTable.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center;">Aucune inspection ne correspond √† vos crit√®res.</td>
          </tr>
        `;
        return;
      }
      
      // Cr√©er les lignes du tableau
      pageInspections.forEach(inspection => {
        const row = document.createElement('tr');
        
        // Formater la date
        const date = inspection.date;
        const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}, ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        
        // Type d'inspection
        const typeText = inspection.type === 'trail' ? 'Sentier' : 'Abri';
        const typeClass = inspection.type === 'trail' ? 'type-trail' : 'type-shelter';
        
        // √âtat
        let statusText = '';
        switch (inspection.condition) {
          case 'good':
            statusText = 'Bon';
            break;
          case 'warning':
            statusText = 'Attention';
            break;
          case 'critical':
            statusText = 'Critique';
            break;
          default:
            statusText = 'Non inspect√©';
        }
        
        row.innerHTML = `
		  <td class="inspection-text">${formattedDate}</td>
		  <td class="inspection-text"><span class="type-badge ${typeClass}">${typeText}</span></td>
		  <td class="inspection-text">${inspection.location}</td>
		  <td class="inspection-text">${inspection.inspector}</td>
		  <td class="inspection-text"><span class="status-badge status-${inspection.condition}">${statusText}</span></td>
		  <td><button class="view-btn" data-id="${inspection.id}" data-type="${inspection.type}">Voir d√©tails</button></td>
        `;
        
        inspectionsTable.appendChild(row);
      });
      
      // Ajouter les √©v√©nements aux boutons de d√©tails
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          const type = this.getAttribute('data-type');
          showInspectionDetails(id, type);
        });
      });
    }

    // Configurer la modal
    function setupModal() {
      // Fermer la modal
      document.querySelector('.modal-close').addEventListener('click', function() {
        modal.style.display = 'none';
      });
      
      // Fermer la modal quand on clique en dehors du contenu
      window.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });
    }

    // Afficher les d√©tails d'une inspection
    async function showInspectionDetails(id, type) {
      showLoading(true);
      
      try {
        // R√©cup√©rer les donn√©es de l'inspection
        let inspectionData;
        let locationData;
        let inspectorData;
        
        if (type === 'trail') {
          // Inspection de sentier
          const doc = await db.collection('trail_inspections').doc(id).get();
          inspectionData = doc.data();
          
          if (inspectionData) {
            // R√©cup√©rer les informations du sentier
            const trailDoc = await db.collection('trails').doc(inspectionData.trail_id).get();
            locationData = trailDoc.data();
            
            // R√©cup√©rer les informations de l'inspecteur
            const inspectorDoc = await db.collection('inspectors').doc(inspectionData.inspector_id).get();
            inspectorData = inspectorDoc.data();
          }
        } else {
          // Inspection d'abri
          const doc = await db.collection('shelter_inspections').doc(id).get();
          inspectionData = doc.data();
          
          if (inspectionData) {
            // R√©cup√©rer les informations de l'abri
            const shelterDoc = await db.collection('shelters').doc(inspectionData.shelter_id).get();
            locationData = shelterDoc.data();
            
            // R√©cup√©rer les informations de l'inspecteur
            const inspectorDoc = await db.collection('inspectors').doc(inspectionData.inspector_id).get();
            inspectorData = inspectorDoc.data();
          }
        }
        
        if (!inspectionData) {
          throw new Error("Inspection non trouv√©e");
        }
        
        // Remplir la modal avec les d√©tails
        fillModalWithInspectionDetails(inspectionData, locationData, inspectorData, type);
        
        // Afficher la modal
        modal.style.display = 'block';
      } catch (error) {
        console.error("Erreur lors du chargement des d√©tails de l'inspection:", error);
        alert("Erreur lors du chargement des d√©tails de l'inspection.");
      } finally {
        showLoading(false);
      }
    }

    // Remplir la modal avec les d√©tails de l'inspection
    function fillModalWithInspectionDetails(inspection, location, inspector, type) {
      const modalContent = document.getElementById('modal-content');
      
      // Type d'emplacement
      const locationTypeText = type === 'trail' ? 'Sentier' : 'Abri';
      const locationName = location ? location.name : (type === 'trail' ? 'Sentier inconnu' : 'Abri inconnu');
      
      // Formater la date
      const date = inspection.date.toDate();
      const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}, ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
      
      // √âtat
      let statusText = '';
      switch (inspection.condition) {
        case 'good':
          statusText = 'Bon';
          break;
        case 'warning':
          statusText = 'Attention';
          break;
        case 'critical':
          statusText = 'Critique';
          break;
        default:
          statusText = 'Non inspect√©';
      }

      
      // Informations sp√©cifiques au type
      let specificInfoHTML = '';
      if (type === 'trail' && location) {
        let difficultyText = '';
        switch (location.difficulty) {
          case 'easy':
            difficultyText = 'Facile';
            break;
          case 'medium':
            difficultyText = 'Interm√©diaire';
            break;
          case 'hard':
            difficultyText = 'Difficile';
            break;
          default:
            difficultyText = 'Inconnue';
        }
        
        specificInfoHTML = `
          <li>
            <div class="detail-label">Longueur</div>
            <div class="detail-value">${location.length || '?'} km</div>
          </li>
          <li>
            <div class="detail-label">Difficult√©</div>
            <div class="detail-value">${difficultyText}</div>
          </li>
        `;
      } else if (type === 'shelter' && location) {
        specificInfoHTML = `
          <li>
            <div class="detail-label">Altitude</div>
            <div class="detail-value">${location.altitude || '?'} m</div>
          </li>
        `;
        
        if (inspection.cleanliness) {
          let cleanlinessText = '';
          let cleanlinessTextDetails = '';
		  switch (inspection.cleanliness) {
            case 'good':
              cleanlinessText = 'Propre';
              break;
            case 'warning':
              cleanlinessText = 'Moyen';
              break;
            case 'critical':
              cleanlinessText = 'Sale';
              break;
          }
		  if (inspection.cleanliness_details) {
			cleanlinessTextDetails = inspection.cleanliness_details;
		  }
          specificInfoHTML += `
            <li>
              <div class="detail-label">Propret√©</div>
              <div class="detail-value">${cleanlinessText} --- ${cleanlinessTextDetails}</div>
            </li>
          `;
        }
        
        if (inspection.accessibility) {
          let accessibilityText = '';
          let accessibilityTextDetails = '';
          switch (inspection.accessibility) {
            case 'good':
              accessibilityText = 'D√©gag√©';
              break;
            case 'warning':
              accessibilityText = 'Partiellement obstru√©';
              break;
            case 'critical':
              accessibilityText = 'Bloqu√©';
              break;
          }
		  if (inspection.accessibility_details) {
			accessibilityTextDetails = inspection.accessibility_details;
		  }
          
          specificInfoHTML += `
            <li>
              <div class="detail-label">Accessibilit√©</div>
              <div class="detail-value">${accessibilityText} --- ${accessibilityTextDetails}</div>
            </li>
          `;
        }
      }
      
      // Probl√®mes signal√©s
      let issuesHTML = '';
      if (inspection.issues && inspection.issues.length > 0) {
        inspection.issues.forEach(issue => {
          issuesHTML += `
            <div class="issue-item">
              <p><strong>${issue}</strong></p>
            </div>
          `;
        });
      } else {
        issuesHTML = '<p>Aucun probl√®me signal√©</p>';
      }
      
      // Photos
      let photosHTML = '';
      if (inspection.photos && inspection.photos.length > 0) {
        photosHTML = '<div class="photo-gallery">';
        inspection.photos.forEach(photoUrl => {
          photosHTML += `
            <div class="gallery-image">
              <img src="${photoUrl}" alt="Photo d'inspection" onclick="window.open('${photoUrl}', '_blank')">
            </div>
          `;
        });
        photosHTML += '</div>';
      } else {
        photosHTML = '<p>Aucune photo disponible</p>';
      }
      
      // Commentaires
      const comments = inspection.comments || 'Aucun commentaire';
      
      // Construction du HTML de la modal
      modalContent.innerHTML = `
		  <div class="inspection-details">
			<div class="detail-box">
			  <h3 class="detail-title" style="color: #1f2937;">Informations g√©n√©rales</h3>
			  <ul class="detail-list">
				<li>
				  <div class="detail-label" style="color: #4b5563;">Type</div>
				  <div class="detail-value" style="color: #1f2937;"><span class="type-badge ${type === 'trail' ? 'type-trail' : 'type-shelter'}">${locationTypeText}</span> ${locationName}</div>
				</li>
				<li>
				  <div class="detail-label" style="color: #4b5563;">Date et heure</div>
				  <div class="detail-value" style="color: #1f2937;">${formattedDate}</div>
				</li>
				<li>
				  <div class="detail-label" style="color: #4b5563;">Inspecteur</div>
				  <div class="detail-value" style="color: #1f2937;">${inspector ? inspector.name : 'Inspecteur inconnu'}</div>
				</li>
				<li>
				  <div class="detail-label" style="color: #4b5563;">√âtat g√©n√©ral</div>
				  <div class="detail-value" style="color: #1f2937;"><span class="status-badge status-${inspection.condition}">${statusText}</span></div>
				</li>
			  </ul>
			</div>
			
			<div class="detail-box">
			  <h3 class="detail-title" style="color: #1f2937;">Probl√®mes signal√©s</h3>
			  <div class="issues-list" style="color: #1f2937;">
				${issuesHTML}
			  </div>
			</div>
			
			<div class="detail-box">
			  <h3 class="detail-title" style="color: #1f2937;">Caract√©ristiques</h3>
			  <ul class="detail-list" style="color: #1f2937;">
				${specificInfoHTML}
			  </ul>
			</div>
		  </div>
		  
		  <div class="detail-box">
			<h3 class="detail-title" style="color: #1f2937;">Commentaires</h3>
			<p style="padding: 0.5rem 0; color: #1f2937;">${comments}</p>
		  </div>
		  
		  <h3 class="detail-title" style="margin: 1.5rem 0 0.75rem; color: #1f2937;">Photos</h3>
		  ${photosHTML}
		`;
    }

    // Configurer l'exportation
    function setupExport() {
      // Exportation en PDF
      document.getElementById('export-pdf').addEventListener('click', function(e) {
        e.preventDefault();
        exportToPDF();
      });
      
      // Exportation en CSV
      document.getElementById('export-csv').addEventListener('click', function(e) {
        e.preventDefault();
        exportToCSV();
      });
      
      // Exportation en Excel
      document.getElementById('export-excel').addEventListener('click', function(e) {
        e.preventDefault();
        exportToExcel();
      });
    }

    // Exporter les donn√©es en PDF
    function exportToPDF() {
      alert('Fonctionnalit√© d\'exportation PDF en cours de d√©veloppement.');
      // Dans une impl√©mentation r√©elle, utilisez une biblioth√®que comme jsPDF
    }

    // Exporter les donn√©es en CSV
    function exportToCSV() {
      try {
        // En-t√™te CSV
        let csvContent = "Date,Type,Sentier/Abri,Inspecteur,√âtat,Probl√®mes,Commentaires\n";
        
        // Ajouter chaque inspection
        filteredInspections.forEach(inspection => {
          // Formater la date
          const date = inspection.date;
          const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
          
          // Type
          const typeText = inspection.type === 'trail' ? 'Sentier' : 'Abri';
          
          // √âtat
          let statusText = '';
          switch (inspection.condition) {
            case 'good':
              statusText = 'Bon';
              break;
            case 'warning':
              statusText = 'Attention';
              break;
            case 'critical':
              statusText = 'Critique';
              break;
            default:
              statusText = 'Non inspect√©';
          }
          
          // Probl√®mes (√©chapper les virgules)
          const issues = inspection.issues.length > 0 
            ? `"${inspection.issues.join('; ').replace(/"/g, '""')}"`
            : '';
          
          // Commentaires (√©chapper les virgules)
          const comments = inspection.comments 
            ? `"${inspection.comments.replace(/"/g, '""')}"`
            : '';
          
          // Ajouter la ligne
          csvContent += `${formattedDate},${typeText},${inspection.location},${inspection.inspector},${statusText},${issues},${comments}\n`;
        });
        
        // Cr√©er un lien pour t√©l√©charger le fichier
        const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + csvContent);
        const link = document.createElement('a');
        link.setAttribute('href', encodedUri);
        link.setAttribute('download', `inspections_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        
        // Cliquer sur le lien pour t√©l√©charger
        link.click();
        
        // Supprimer le lien
        document.body.removeChild(link);
      } catch (error) {
        console.error("Erreur lors de l'exportation CSV:", error);
        alert("Erreur lors de l'exportation en CSV.");
      }
    }

    // Exporter les donn√©es en Excel
    function exportToExcel() {
      alert('Fonctionnalit√© d\'exportation Excel en cours de d√©veloppement.');
      // Dans une impl√©mentation r√©elle, utilisez une biblioth√®que comme SheetJS (xlsx)
    }

    // Afficher/masquer l'indicateur de chargement
	function showLoading(show) {
	  const overlay = document.getElementById('loading-overlay');
	  if (overlay) {
		overlay.style.display = show ? 'flex' : 'none';
	  }
	}

    // D√©clarer loadInspectionHistory comme une fonction globale pour qu'elle soit accessible depuis auth.js
    window.loadInspectionHistory = loadInspectionHistory;
  </script>
</body>
</html>
    }