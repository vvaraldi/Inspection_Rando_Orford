<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SkiTrack - Historique des inspections</title>
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    
    .page-header {
      margin-bottom: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .filter-container {
      background-color: white;
      border-radius: 0.5rem;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-label {
      display: block;
      margin-bottom: 0.375rem;
      font-weight: 500;
      font-size: 0.875rem;
      color: #4b5563;
    }
    
    .filter-control {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      font-size: 0.875rem;
    }
    
    .search-box {
      display: flex;
      align-items: center;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      padding: 0.5rem 0.75rem;
      width: 100%;
      background-color: white;
    }
    
    .search-icon {
      color: #9ca3af;
      margin-right: 0.5rem;
    }
    
    .search-input {
      border: none;
      outline: none;
      width: 100%;
      font-size: 0.875rem;
    }
    
    .filter-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }
    
    .btn {
      background-color: #1a56db;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.875rem;
    }
    
    .btn:hover {
      background-color: #1e429f;
    }
    
    .btn-secondary {
      background-color: white;
      color: #4b5563;
      border: 1px solid #d1d5db;
    }
    
    .btn-secondary:hover {
      background-color: #f9fafb;
    }
    
    .export-dropdown {
      position: relative;
      display: inline-block;
    }
    
    .export-dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      min-width: 160px;
      z-index: 1;
      background-color: white;
      border-radius: 0.375rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    
    .export-dropdown:hover .export-dropdown-content {
      display: block;
    }
    
    .export-dropdown-item {
      padding: 0.75rem 1rem;
      text-decoration: none;
      display: block;
      color: #4b5563;
      font-size: 0.875rem;
    }
    
    .export-dropdown-item:hover {
      background-color: #f3f4f6;
    }
    
    .table-container {
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 1rem;
      text-align: left;
    }
    
    th {
      background-color: #f9fafb;
      font-weight: 600;
      color: #4b5563;
      font-size: 0.875rem;
      border-bottom: 1px solid #e5e7eb;
      position: relative;
      cursor: pointer;
    }
    
    th:hover {
      background-color: #f3f4f6;
    }
    
    th::after {
      content: "⇅";
      position: absolute;
      right: 0.5rem;
      color: #9ca3af;
      font-size: 0.75rem;
    }
    
    tbody tr {
      border-bottom: 1px solid #e5e7eb;
    }
    
    tbody tr:last-child {
      border-bottom: none;
    }
    
    tbody tr:hover {
      background-color: #f9fafb;
    }
    
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .status-good {
      background-color: #def7ec;
      color: #0e9f6e;
    }
    
    .status-warning {
      background-color: #feecdc;
      color: #ff5a1f;
    }
    
    .status-critical {
      background-color: #fde8e8;
      color: #e02424;
    }
    
    .status-not-inspected {
      background-color: #f3f4f6;
      color: #6b7280;
    }
    
    .type-badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 500;
      margin-right: 0.5rem;
    }
    
    .type-trail {
      background-color: #dbeafe;
      color: #1e40af;
    }
    
    .type-shelter {
      background-color: #f3e8ff;
      color: #5b21b6;
    }
    
    .view-btn {
      padding: 0.375rem 0.75rem;
      border: none;
      border-radius: 0.25rem;
      background-color: #f3f4f6;
      color: #4b5563;
      font-size: 0.75rem;
      cursor: pointer;
    }
    
    .view-btn:hover {
      background-color: #e5e7eb;
    }
    
    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-top: 1px solid #e5e7eb;
    }
    
    .pagination-info {
      color: #6b7280;
      font-size: 0.875rem;
    }
    
    .pagination-buttons {
      display: flex;
      gap: 0.25rem;
    }
    
    .page-btn {
      padding: 0.375rem 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.25rem;
      background-color: white;
      color: #4b5563;
      font-size: 0.875rem;
      cursor: pointer;
    }
    
    .page-btn:hover {
      background-color: #f9fafb;
    }
    
    .page-btn.active {
      background-color: #1a56db;
      color: white;
      border-color: #1a56db;
    }
    
    .page-btn:disabled {
      background-color: #f3f4f6;
      color: #9ca3af;
      cursor: not-allowed;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 100;
      overflow-y: auto;
    }
    
    .modal-content {
      background-color: white;
      border-radius: 0.5rem;
      margin: 2rem auto;
      width: 90%;
      max-width: 900px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .modal-header {
      padding: 1.25rem;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
    }
    
    .modal-close {
      border: none;
      background-color: transparent;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6b7280;
    }
    
    .modal-body {
      padding: 1.25rem;
    }
    
    .inspection-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .detail-box {
      background-color: #f9fafb;
      border-radius: 0.375rem;
      padding: 1rem;
    }
    
    .detail-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #4b5563;
    }
    
    .detail-list {
      list-style: none;
    }
    
    .detail-list li {
      padding: 0.5rem 0;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .detail-list li:last-child {
      border-bottom: none;
    }
    
    .detail-label {
      color: #6b7280;
      font-size: 0.875rem;
      margin-bottom: 0.25rem;
    }
    
    .detail-value {
      font-weight: 500;
    }
    
    .issues-container {
      margin-bottom: 1.5rem;
    }
    
    .photo-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    
    .gallery-image {
      border-radius: 0.375rem;
      overflow: hidden;
      aspect-ratio: 1;
    }
    
    .gallery-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .history-chart {
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
      padding: 1rem;
      height: 300px;
      position: relative;
    }
    
    .chart-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #9ca3af;
      font-style: italic;
    }
    
    @media (max-width: 768px) {
      .filter-row {
        flex-direction: column;
      }
      
      .filter-buttons {
        justify-content: space-between;
      }
      
      .inspection-details {
        grid-template-columns: 1fr;
      }
      
      .photo-gallery {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
    }

    /* Ajout d'un indicateur de chargement */
    #loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }

    .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border-left-color: #1a56db;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }


.table-container table {
  width: 100%;
  border-collapse: collapse;
  color: #1f2937; /* Couleur de texte foncée explicite */
}

tbody tr {
  border-bottom: 1px solid #e5e7eb;
  background-color: white; /* Explicitement blanc */
  color: #1f2937; /* Couleur de texte foncée explicite */
}
	
	  /* Style pour le menu mobile */
  .mobile-menu-btn {
    display: none; /* Caché par défaut sur desktop */
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.5rem;
  }
  
  .mobile-nav {
    display: none; /* Caché par défaut */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #1a56db;
    z-index: 1000;
    flex-direction: column;
  }
  
  .mobile-nav-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .mobile-nav-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
  }
  
  .mobile-nav-links {
    display: flex;
    flex-direction: column;
    padding: 1rem;
  }
  
  .mobile-nav-links a {
    color: white;
    text-decoration: none;
    padding: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    font-size: 1.2rem;
  }
  
  .mobile-nav-links a.active {
    background-color: rgba(255, 255, 255, 0.2);
  }
  
  /* Media query pour mobile */
  @media (max-width: 768px) {
    .nav-links {
      display: none; /* Cacher les liens de navigation standard */
    }
    
    .mobile-menu-btn {
      display: block; /* Afficher le bouton du menu mobile */
    }
    
    .mobile-nav.open {
      display: flex; /* Afficher le menu mobile quand il est ouvert */
    }
  }
	
.table-container table,
.modal-content,
.inspection-details,
.detail-box,
.popup-body,
.detail-list li,
.issue-item {
  color: #1f2937 !important; /* Couleur de texte foncée pour tous les éléments importants */
}

/* Assurer que les cellules du tableau ont une couleur de texte correcte */
.table-container th,
.table-container td {
  color: #1f2937 !important;
}

/* Correction pour les détails dans la modale */
.modal-body {
  color: #1f2937 !important;
}

.modal-body p,
.modal-body h3,
.detail-label,
.detail-value,
.popup-title {
  color: #1f2937 !important;
}

/* Exceptions spécifiques pour les badges de statut */
.status-badge,
.type-badge {
  /* Ces éléments ont leur propre couleur définie par leurs classes spécifiques */
  color: inherit;
}

/* Effets de survol pour les lignes du tableau */
tbody tr:hover {
  background-color: #f9fafb !important;
  color: #1f2937 !important;
}
	
  </style>
</head>

<script>
  window.onerror = function(message, source, lineno, colno, error) {
    console.log("Erreur JavaScript: ", message, "à la ligne", lineno, "colonne", colno);
    console.log("Source:", source);
    console.log("Erreur complète:", error);
    
    // Afficher le contenu en cas d'erreur
    document.getElementById('loading').style.display = 'none';
    document.getElementById('main-content').style.display = 'block';
    
    return true; // Empêche l'affichage de l'erreur dans la console
  };
</script>

<body>
  <header>
  <nav>
    <div class="logo">SkiTrack - Mont Orford</div>
    <!-- Menu desktop -->
    <div class="nav-links">
		<a href="../index.html">Tableau de bord</a>
		<a href="trail-inspection.html">Inspection sentier</a>
		<a href="shelter-inspection.html">Inspection abri</a>
		<a href="inspection-history.html" class="active">Historique</a>
		<a href="admin.html" id="admin-link" style="display: none;">Administration</a>
		<a href="change-password.html">Mot de passe</a>
		<a href="#" id="login-link">Connexion</a>
    </div>
    <!-- Bouton du menu mobile -->
    <button class="mobile-menu-btn" id="mobile-menu-btn">☰</button>
  </nav>
  
  <!-- Menu mobile -->
  <div class="mobile-nav" id="mobile-nav">
    <div class="mobile-nav-header">
      <div class="logo">SkiTrack</div>
      <button class="mobile-nav-close" id="mobile-nav-close">✕</button>
    </div>
    <div class="mobile-nav-links">
      <a href="../index.html">Tableau de bord</a>
      <a href="trail-inspection.html">Inspection sentier</a>
      <a href="shelter-inspection.html">Inspection abri</a>
      <a href="inspection-history.html" class="active">Historique</a>
      <a href="admin.html" id="mobile-admin-link" style="display: none;">Administration</a>
	  <a href="change-password.html" id="mobile-password-link">Mot de passe</a>
      <a href="#" id="mobile-login-link">Connexion</a>
    </div>
  </div>
  </header>

  <!-- Indicateur de chargement principal -->
  <div id="loading">
    <div style="text-align: center;">
      <div class="loading-spinner"></div>
      <p>Vérification de l'authentification...</p>
    </div>
  </div>
  
  <!-- Contenu principal - caché initialement -->
  <div id="main-content" style="display: none;">
    <main>
      <div class="page-header">
        <h1>Historique des inspections</h1>
        
        <div class="export-dropdown">
          <button class="btn btn-secondary">Exporter <span>▼</span></button>
          <div class="export-dropdown-content">
            <a href="#" class="export-dropdown-item" id="export-pdf">Exporter en PDF</a>
            <a href="#" class="export-dropdown-item" id="export-csv">Exporter en CSV</a>
            <a href="#" class="export-dropdown-item" id="export-excel">Exporter en Excel</a>
          </div>
        </div>
      </div>
      
      <div class="filter-container">
        <div class="filter-row">
          <div class="filter-group">
            <label class="filter-label" for="period-filter">Période</label>
            <select class="filter-control" id="period-filter">
              <option value="all">Toutes les dates</option>
              <option value="today">Aujourd'hui</option>
              <option value="week">Cette semaine</option>
              <option value="month">Ce mois</option>
              <option value="custom">Période personnalisée</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label" for="type-filter">Type</label>
            <select class="filter-control" id="type-filter">
              <option value="all">Tous les types</option>
              <option value="trail">Sentiers</option>
              <option value="shelter">Abris</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label" for="location-filter">Sentier/Abri</label>
            <select class="filter-control" id="location-filter">
              <option value="all">Tous</option>
              <!-- Les options seront chargées dynamiquement -->
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label" for="status-filter">État</label>
            <select class="filter-control" id="status-filter">
              <option value="all">Tous les états</option>
              <option value="good">Bon</option>
              <option value="warning">Attention</option>
              <option value="critical">Critique</option>
            </select>
          </div>
        </div>
        
        <div class="filter-row">
          <div class="filter-group">
            <label class="filter-label" for="inspector-filter">Inspecteur</label>
            <select class="filter-control" id="inspector-filter">
              <option value="all">Tous les inspecteurs</option>
              <!-- Les options seront chargées dynamiquement -->
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Recherche</label>
            <div class="search-box">
              <span class="search-icon">🔍</span>
              <input type="text" class="search-input" id="search-input" placeholder="Rechercher...">
            </div>
          </div>
        </div>
        
        <div class="filter-buttons">
          <button class="btn btn-secondary" id="reset-filters">Réinitialiser</button>
          <button class="btn" id="apply-filters">Appliquer</button>
        </div>
      </div>
      
      <div class="table-container" style="position: relative;">
        <!-- Indicateur de chargement pour le tableau -->
        <div id="loading-overlay" style="display: none;">
          <div class="loading-spinner"></div>
        </div>

        <table>
          <thead>
            <tr>
              <th data-sort="date">Date</th>
              <th data-sort="type">Type</th>
              <th data-sort="location">Sentier/Abri</th>
              <th data-sort="inspector">Inspecteur</th>
              <th data-sort="condition">État</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="inspections-table">
            <!-- Les données seront chargées dynamiquement -->
            <tr>
              <td colspan="6" style="text-align: center;">Chargement des données...</td>
            </tr>
          </tbody>
        </table>
        
        <div class="pagination">
          <div class="pagination-info" id="pagination-info">
            Affichage de 1 à 10 sur 0 entrées
          </div>
          
          <div class="pagination-buttons" id="pagination-buttons">
            <button class="page-btn" disabled>&laquo;</button>
            <button class="page-btn active">1</button>
            <button class="page-btn">&raquo;</button>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Modal de détails d'inspection -->
  <div id="inspection-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Détails de l'inspection</h2>
        <button class="modal-close">&times;</button>
      </div>
      
      <div class="modal-body" id="modal-content">
        <!-- Le contenu de la modal sera généré dynamiquement -->
      </div>
    </div>
  </div>
  
  <!-- Scripts Firebase nouveau 
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore-compat.js"></script>-->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

  
  <!-- Scripts de l'application -->
  <script src="../js/auth.js"></script>

  <script>
    // Variables pour la pagination et le tri
    let currentPage = 1;
    const pageSize = 10;
    let totalItems = 0;
    let allInspections = [];
    let filteredInspections = [];
    let sortField = 'date';
    let sortDirection = 'desc';
    let currentFilters = {
      period: 'all',
      type: 'all',
      location: 'all',
      status: 'all',
      inspector: 'all',
      search: ''
    };

    // Éléments du DOM
    const loadingOverlay = document.getElementById('loading-overlay');
    const inspectionsTable = document.getElementById('inspections-table');
    const paginationInfo = document.getElementById('pagination-info');
    const paginationButtons = document.getElementById('pagination-buttons');
    const modal = document.getElementById('inspection-modal');
    
    // Référence à Storage
let storage = null;
try {
  if (typeof firebase !== 'undefined' && firebase.storage) {
    storage = firebase.storage();
  } else {
    console.warn("Firebase Storage n'est pas disponible");
  }
} catch (error) {
  console.error("Erreur lors de l'initialisation de Firebase Storage:", error);
}
    
// Initialisation lors du chargement du document
document.addEventListener('DOMContentLoaded', function() {

    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileNavClose = document.getElementById('mobile-nav-close');
    const mobileNav = document.getElementById('mobile-nav');
    const mobileLoginLink = document.getElementById('mobile-login-link');
    const loginLink = document.getElementById('login-link');
    const mobileAdminLink = document.getElementById('mobile-admin-link');
    const adminLink = document.getElementById('admin-link');
    
    // Ouvrir le menu mobile
    if (mobileMenuBtn) {
      mobileMenuBtn.addEventListener('click', function() {
        mobileNav.classList.add('open');
      });
    }
    
    // Fermer le menu mobile
    if (mobileNavClose) {
      mobileNavClose.addEventListener('click', function() {
        mobileNav.classList.remove('open');
      });
    }
    
    // Synchroniser les liens de login
    if (mobileLoginLink && loginLink) {
      mobileLoginLink.textContent = loginLink.textContent;
      mobileLoginLink.href = loginLink.href;
      mobileLoginLink.onclick = function(e) {
        e.preventDefault();
        if (loginLink.onclick) {
          loginLink.onclick(e);
        }
        mobileNav.classList.remove('open');  // Fermer le menu après clic
      };
    }
    
    // Synchroniser la visibilité du lien d'administration
    if (mobileAdminLink && adminLink) {
      mobileAdminLink.style.display = adminLink.style.display;
    }
    
    // Fermer le menu mobile quand on clique sur un lien
    document.querySelectorAll('.mobile-nav-links a').forEach(link => {
      link.addEventListener('click', function() {
        mobileNav.classList.remove('open');
      });
    });
    
    // Fermer le menu mobile quand on clique en dehors
    document.addEventListener('click', function(e) {
      if (mobileNav.classList.contains('open') && 
          !mobileNav.contains(e.target) && 
          e.target !== mobileMenuBtn) {
        mobileNav.classList.remove('open');
      }
    });
    
    console.log('Menu mobile initialisé'); 

 // Configurer les filtres
  setupFilters();
  
  // Configurer le tri
  setupTableSorting();
  
  // Configurer la pagination
  setupPagination();
  
  // Configurer la modal
  setupModal();
  
  // Configurer l'exportation
  setupExport();
});

	// Déclarer loadInspectionHistory comme une fonction globale pour qu'elle soit accessible depuis auth.js
	window.loadInspectionHistory = function() {
	  try {
		showLoading(true);
		
		// Charger les données des emplacements pour les filtres
		loadLocationsForFilter().then(() => {
		  // Charger les données des inspecteurs pour les filtres
		  return loadInspectorsForFilter();
		}).then(() => {
		  // Charger toutes les inspections
		  return loadAllInspections();
		}).then(() => {
		  // Appliquer les filtres par défaut
		  applyFilters();
		  showLoading(false);
		}).catch(error => {
		  console.error("Erreur lors du chargement de l'historique:", error);
		  showLoading(false);
		  // Afficher un message d'erreur
		  const table = document.getElementById('inspections-table');
		  if (table) {
			table.innerHTML = `
			  <tr>
				<td colspan="6" style="text-align: center; color: #e02424;">
				  Erreur lors du chargement des données. Veuillez réessayer.
				</td>
			  </tr>
			`;
		  }
		});
	  } catch (error) {
		console.error("Erreur lors du chargement de l'historique:", error);
		showLoading(false);
	  }
	};

    // Fonction appelée après l'authentification réussie
    async function loadInspectionHistory() {
      try {
        showLoading(true);
        
        // Charger les données des emplacements pour les filtres
        await loadLocationsForFilter();
        
        // Charger les données des inspecteurs pour les filtres
        await loadInspectorsForFilter();
        
        // Charger toutes les inspections
        await loadAllInspections();
        
        // Appliquer les filtres par défaut
        applyFilters();
        
        showLoading(false);
      } catch (error) {
        console.error("Erreur lors du chargement de l'historique:", error);
        showLoading(false);
        // Afficher un message d'erreur
        inspectionsTable.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; color: #e02424;">
              Erreur lors du chargement des données. Veuillez réessayer.
            </td>
          </tr>
        `;
      }
    }

    // Charger les données des sentiers et abris pour le filtre
    async function loadLocationsForFilter() {
      try {
        const locationFilter = document.getElementById('location-filter');
        locationFilter.innerHTML = '<option value="all">Tous</option>';
        
        // Groupe pour les sentiers
        const trailOptgroup = document.createElement('optgroup');
        trailOptgroup.label = "Sentiers";
        
        // Récupérer les sentiers
        const trailsSnapshot = await db.collection('trails').orderBy('name').get();
        trailsSnapshot.forEach(doc => {
          const trail = doc.data();
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = `${trail.name}`;
          trailOptgroup.appendChild(option);
        });
        
        // Groupe pour les abris
        const shelterOptgroup = document.createElement('optgroup');
        shelterOptgroup.label = "Abris";
        
        // Récupérer les abris
        const sheltersSnapshot = await db.collection('shelters').orderBy('name').get();
        sheltersSnapshot.forEach(doc => {
          const shelter = doc.data();
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = `${shelter.name}`;
          shelterOptgroup.appendChild(option);
        });
        
        // Ajouter les groupes au select
        locationFilter.appendChild(trailOptgroup);
        locationFilter.appendChild(shelterOptgroup);
      } catch (error) {
        console.error("Erreur lors du chargement des emplacements:", error);
      }
    }

    // Charger les données des inspecteurs pour le filtre
    async function loadInspectorsForFilter() {
      try {
        const inspectorFilter = document.getElementById('inspector-filter');
        inspectorFilter.innerHTML = '<option value="all">Tous les inspecteurs</option>';
        
        // Récupérer les inspecteurs
        const inspectorsSnapshot = await db.collection('inspectors').orderBy('name').get();
        inspectorsSnapshot.forEach(doc => {
          const inspector = doc.data();
          if (inspector.status === 'active') {
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = inspector.name;
            inspectorFilter.appendChild(option);
          }
        });
      } catch (error) {
        console.error("Erreur lors du chargement des inspecteurs:", error);
      }
    }

    // Charger toutes les inspections
    async function loadAllInspections() {
      allInspections = [];
      
      // Récupérer les inspections de sentiers
      const trailInspections = await loadTrailInspections();
      
      // Récupérer les inspections d'abris
      const shelterInspections = await loadShelterInspections();
      
      // Combiner les deux types d'inspection
      allInspections = [...trailInspections, ...shelterInspections];
      
      // Trier par date décroissante (plus récent en premier)
      allInspections.sort((a, b) => b.date.getTime() - a.date.getTime());
      
      return allInspections;
    }

    // Charger les inspections de sentiers
    async function loadTrailInspections() {
      const trailInspections = [];
      
      try {
        // Récupérer toutes les inspections de sentiers
        const snapshot = await db.collection('trail_inspections')
          .orderBy('date', 'desc')
          .get();
        
        // Créer une map des sentiers pour accéder rapidement aux noms
        const trailsMap = await getTrailsMap();
        
        // Créer une map des inspecteurs pour accéder rapidement aux noms
        const inspectorsMap = await getInspectorsMap();
        
        for (const doc of snapshot.docs) {
          const data = doc.data();
          const trailId = data.trail_id;
          const inspectorId = data.inspector_id;
          
          // Obtenir les informations du sentier
          const trail = trailsMap.get(trailId) || { name: 'Sentier inconnu' };
          
          // Obtenir les informations de l'inspecteur
          const inspector = inspectorsMap.get(inspectorId) || { name: 'Inspecteur inconnu' };
          
          trailInspections.push({
            id: doc.id,
            type: 'trail',
            date: data.date.toDate(),
            location: trail.name,
            locationId: trailId,
            inspector: inspector.name,
            inspectorId: inspectorId,
            condition: data.condition || 'not-inspected',
            issues: data.issues || [],
            comments: data.comments || '',
            photos: data.photos || [],
            rawData: data
          });
        }
      } catch (error) {
        console.error("Erreur lors du chargement des inspections de sentiers:", error);
      }
      
      return trailInspections;
    }

    // Charger les inspections d'abris
    async function loadShelterInspections() {
      const shelterInspections = [];
      
      try {
        // Récupérer toutes les inspections d'abris
        const snapshot = await db.collection('shelter_inspections')
          .orderBy('date', 'desc')
          .get();
        
        // Créer une map des abris pour accéder rapidement aux noms
        const sheltersMap = await getSheltersMap();
        
        // Créer une map des inspecteurs pour accéder rapidement aux noms
        const inspectorsMap = await getInspectorsMap();
        
        for (const doc of snapshot.docs) {
          const data = doc.data();
          const shelterId = data.shelter_id;
          const inspectorId = data.inspector_id;
          
          // Obtenir les informations de l'abri
          const shelter = sheltersMap.get(shelterId) || { name: 'Abri inconnu' };
          
          // Obtenir les informations de l'inspecteur
          const inspector = inspectorsMap.get(inspectorId) || { name: 'Inspecteur inconnu' };
          
          shelterInspections.push({
            id: doc.id,
            type: 'shelter',
            date: data.date.toDate(),
            location: shelter.name,
            locationId: shelterId,
            inspector: inspector.name,
            inspectorId: inspectorId,
            condition: data.condition || 'not-inspected',
            issues: data.issues || [],
            comments: data.comments || '',
            photos: data.photos || [],
            rawData: data
          });
        }
      } catch (error) {
        console.error("Erreur lors du chargement des inspections d'abris:", error);
      }
      
      return shelterInspections;
    }

    // Obtenir une map des sentiers
    async function getTrailsMap() {
      const trailsMap = new Map();
      
      try {
        const snapshot = await db.collection('trails').get();
        snapshot.forEach(doc => {
          trailsMap.set(doc.id, doc.data());
        });
      } catch (error) {
        console.error("Erreur lors du chargement des sentiers:", error);
      }
      
      return trailsMap;
    }

    // Obtenir une map des abris
    async function getSheltersMap() {
      const sheltersMap = new Map();
      
      try {
        const snapshot = await db.collection('shelters').get();
        snapshot.forEach(doc => {
          sheltersMap.set(doc.id, doc.data());
        });
      } catch (error) {
        console.error("Erreur lors du chargement des abris:", error);
      }
      
      return sheltersMap;
    }

    // Obtenir une map des inspecteurs
    async function getInspectorsMap() {
      const inspectorsMap = new Map();
      
      try {
        const snapshot = await db.collection('inspectors').get();
        snapshot.forEach(doc => {
          inspectorsMap.set(doc.id, doc.data());
        });
      } catch (error) {
        console.error("Erreur lors du chargement des inspecteurs:", error);
      }
      
      return inspectorsMap;
    }

    // Configurer les filtres
    function setupFilters() {
      // Événements pour les filtres
      document.getElementById('reset-filters').addEventListener('click', resetFilters);
      document.getElementById('apply-filters').addEventListener('click', applyFilters);
      
      // Événement de recherche
      document.getElementById('search-input').addEventListener('input', function() {
        // Appliquer la recherche après un court délai pour éviter trop de requêtes
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(() => {
          currentFilters.search = this.value.trim().toLowerCase();
          applyFilters();
        }, 300);
      });
    }

    // Réinitialiser tous les filtres
    function resetFilters() {
      document.getElementById('period-filter').value = 'all';
      document.getElementById('type-filter').value = 'all';
      document.getElementById('location-filter').value = 'all';
      document.getElementById('status-filter').value = 'all';
      document.getElementById('inspector-filter').value = 'all';
      document.getElementById('search-input').value = '';
      
      currentFilters = {
        period: 'all',
        type: 'all',
        location: 'all',
        status: 'all',
        inspector: 'all',
        search: ''
      };
      
      applyFilters();
    }

    // Appliquer les filtres
    function applyFilters() {
      showLoading(true);
      
      // Récupérer les valeurs des filtres
      currentFilters.period = document.getElementById('period-filter').value;
      currentFilters.type = document.getElementById('type-filter').value;
      currentFilters.location = document.getElementById('location-filter').value;
      currentFilters.status = document.getElementById('status-filter').value;
      currentFilters.inspector = document.getElementById('inspector-filter').value;
      currentFilters.search = document.getElementById('search-input').value.trim().toLowerCase();
      
      // Filtrer les inspections
      filteredInspections = allInspections.filter(inspection => {
        // Filtrer par période
        if (currentFilters.period !== 'all') {
          const now = new Date();
          const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          
          switch (currentFilters.period) {
            case 'today':
              if (inspection.date < today) return false;
              break;
            case 'week':
              const weekAgo = new Date(now);
              weekAgo.setDate(weekAgo.getDate() - 7);
              if (inspection.date < weekAgo) return false;
              break;
            case 'month':
              const monthAgo = new Date(now);
              monthAgo.setMonth(monthAgo.getMonth() - 1);
              if (inspection.date < monthAgo) return false;
              break;
          }
        }
        
        // Filtrer par type
        if (currentFilters.type !== 'all' && inspection.type !== currentFilters.type) {
          return false;
        }
        
        // Filtrer par emplacement
        if (currentFilters.location !== 'all' && inspection.locationId !== currentFilters.location) {
          return false;
        }
        
        // Filtrer par état
        if (currentFilters.status !== 'all' && inspection.condition !== currentFilters.status) {
          return false;
        }
        
        // Filtrer par inspecteur
        if (currentFilters.inspector !== 'all' && inspection.inspectorId !== currentFilters.inspector) {
          return false;
        }
        
        // Filtrer par recherche textuelle
        if (currentFilters.search) {
          const searchTerms = currentFilters.search.split(' ');
          
          // Vérifier si tous les termes sont présents
          return searchTerms.every(term => {
            return (
              inspection.location.toLowerCase().includes(term) ||
              inspection.inspector.toLowerCase().includes(term) ||
              inspection.comments.toLowerCase().includes(term) ||
              inspection.issues.some(issue => issue.toLowerCase().includes(term))
            );
          });
        }
        
        return true;
      });
      
      // Appliquer le tri actuel
      sortInspections(sortField, sortDirection);
      
      // Mettre à jour la pagination
      totalItems = filteredInspections.length;
      currentPage = 1;
      updatePagination();
      
      // Afficher les résultats
      displayInspections();
      
      showLoading(false);
    }

    // Configurer le tri des colonnes
    function setupTableSorting() {
      document.querySelectorAll('th[data-sort]').forEach(header => {
        header.addEventListener('click', function() {
          const field = this.getAttribute('data-sort');
          
          // Inverser la direction si on clique sur la colonne déjà triée
          if (field === sortField) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            sortField = field;
            sortDirection = 'asc';
          }
          
          // Appliquer le tri
          sortInspections(sortField, sortDirection);
          
          // Mettre à jour l'affichage
          displayInspections();
          
          // Mettre à jour l'indicateur visuel de tri
          document.querySelectorAll('th[data-sort]').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
          });
          this.classList.add(`sort-${sortDirection}`);
        });
      });
    }

    // Trier les inspections
    function sortInspections(field, direction) {
      filteredInspections.sort((a, b) => {
        let valueA, valueB;
        
        switch (field) {
          case 'date':
            valueA = a.date.getTime();
            valueB = b.date.getTime();
            break;
          case 'type':
            valueA = a.type;
            valueB = b.type;
            break;
          case 'location':
            valueA = a.location;
            valueB = b.location;
            break;
          case 'inspector':
            valueA = a.inspector;
            valueB = b.inspector;
            break;
          case 'condition':
            // Ordre personnalisé pour les conditions
            const order = { 'critical': 0, 'warning': 1, 'good': 2, 'not-inspected': 3 };
            valueA = order[a.condition];
            valueB = order[b.condition];
            break;
          default:
            valueA = a.date.getTime();
            valueB = b.date.getTime();
        }
        
        // Comparer les valeurs en tenant compte de la direction du tri
        if (direction === 'asc') {
          return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
        } else {
          return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
        }
      });
    }

    // Configurer la pagination
    function setupPagination() {
      document.getElementById('pagination-buttons').addEventListener('click', function(e) {
        if (e.target.classList.contains('page-btn')) {
          // Déterminer la page à afficher
          if (e.target.textContent === '«') {
            // Bouton précédent
            if (currentPage > 1) {
              currentPage--;
            }
          } else if (e.target.textContent === '»') {
            // Bouton suivant
            if (currentPage < Math.ceil(totalItems / pageSize)) {
              currentPage++;
            }
          } else {
            // Numéro de page
            currentPage = parseInt(e.target.textContent);
          }
          
          // Mettre à jour la pagination et l'affichage
          updatePagination();
          displayInspections();
        }
      });
    }

    // Mettre à jour la pagination
    function updatePagination() {
      const totalPages = Math.ceil(totalItems / pageSize);
      const startItem = (currentPage - 1) * pageSize + 1;
      const endItem = Math.min(startItem + pageSize - 1, totalItems);
      
      // Mettre à jour l'info de pagination
      paginationInfo.textContent = `Affichage de ${totalItems > 0 ? startItem : 0} à ${endItem} sur ${totalItems} entrées`;
      
      // Générer les boutons de pagination
      let paginationHTML = '';
      
      // Bouton précédent
      paginationHTML += `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''}>&laquo;</button>`;
      
      // Pages
      if (totalPages <= 7) {
        // Afficher toutes les pages si moins de 7
        for (let i = 1; i <= totalPages; i++) {
          paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}">${i}</button>`;
        }
      } else {
        // Afficher un nombre limité de pages avec ellipsis
        if (currentPage <= 3) {
          // Près du début
          for (let i = 1; i <= 5; i++) {
            paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}">${i}</button>`;
          }
          paginationHTML += `<span class="page-ellipsis">...</span>`;
          paginationHTML += `<button class="page-btn">${totalPages}</button>`;
        } else if (currentPage >= totalPages - 2) {
          // Près de la fin
          paginationHTML += `<button class="page-btn">1</button>`;
          paginationHTML += `<span class="page-ellipsis">...</span>`;
          for (let i = totalPages - 4; i <= totalPages; i++) {
            paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}">${i}</button>`;
          }
        } else {
          // Au milieu
          paginationHTML += `<button class="page-btn">1</button>`;
          paginationHTML += `<span class="page-ellipsis">...</span>`;
          for (let i = currentPage - 1; i <= currentPage + 1; i++) {
            paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}">${i}</button>`;
          }
          paginationHTML += `<span class="page-ellipsis">...</span>`;
          paginationHTML += `<button class="page-btn">${totalPages}</button>`;
        }
      }
      
      // Bouton suivant
      paginationHTML += `<button class="page-btn" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}>&raquo;</button>`;
      
      // Mettre à jour les boutons
      paginationButtons.innerHTML = paginationHTML;
    }

    // Afficher les inspections pour la page actuelle
    function displayInspections() {
      // Calculer les limites de la page actuelle
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = startIndex + pageSize;
      const pageInspections = filteredInspections.slice(startIndex, endIndex);
      
      // Vider le tableau
      inspectionsTable.innerHTML = '';
      
      // Afficher un message si aucune inspection
      if (pageInspections.length === 0) {
        inspectionsTable.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center;">Aucune inspection ne correspond à vos critères.</td>
          </tr>
        `;
        return;
      }
      
      // Créer les lignes du tableau
      pageInspections.forEach(inspection => {
        const row = document.createElement('tr');
        
        // Formater la date
        const date = inspection.date;
        const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}, ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        
        // Type d'inspection
        const typeText = inspection.type === 'trail' ? 'Sentier' : 'Abri';
        const typeClass = inspection.type === 'trail' ? 'type-trail' : 'type-shelter';
        
        // État
        let statusText = '';
        switch (inspection.condition) {
          case 'good':
            statusText = 'Bon';
            break;
          case 'warning':
            statusText = 'Attention';
            break;
          case 'critical':
            statusText = 'Critique';
            break;
          default:
            statusText = 'Non inspecté';
        }
        
        row.innerHTML = `
		  <td class="inspection-text">${formattedDate}</td>
		  <td class="inspection-text"><span class="type-badge ${typeClass}">${typeText}</span></td>
		  <td class="inspection-text">${inspection.location}</td>
		  <td class="inspection-text">${inspection.inspector}</td>
		  <td class="inspection-text"><span class="status-badge status-${inspection.condition}">${statusText}</span></td>
		  <td><button class="view-btn" data-id="${inspection.id}" data-type="${inspection.type}">Voir détails</button></td>
        `;
        
        inspectionsTable.appendChild(row);
      });
      
      // Ajouter les événements aux boutons de détails
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          const type = this.getAttribute('data-type');
          showInspectionDetails(id, type);
        });
      });
    }

    // Configurer la modal
    function setupModal() {
      // Fermer la modal
      document.querySelector('.modal-close').addEventListener('click', function() {
        modal.style.display = 'none';
      });
      
      // Fermer la modal quand on clique en dehors du contenu
      window.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });
    }

    // Afficher les détails d'une inspection
    async function showInspectionDetails(id, type) {
      showLoading(true);
      
      try {
        // Récupérer les données de l'inspection
        let inspectionData;
        let locationData;
        let inspectorData;
        
        if (type === 'trail') {
          // Inspection de sentier
          const doc = await db.collection('trail_inspections').doc(id).get();
          inspectionData = doc.data();
          
          if (inspectionData) {
            // Récupérer les informations du sentier
            const trailDoc = await db.collection('trails').doc(inspectionData.trail_id).get();
            locationData = trailDoc.data();
            
            // Récupérer les informations de l'inspecteur
            const inspectorDoc = await db.collection('inspectors').doc(inspectionData.inspector_id).get();
            inspectorData = inspectorDoc.data();
          }
        } else {
          // Inspection d'abri
          const doc = await db.collection('shelter_inspections').doc(id).get();
          inspectionData = doc.data();
          
          if (inspectionData) {
            // Récupérer les informations de l'abri
            const shelterDoc = await db.collection('shelters').doc(inspectionData.shelter_id).get();
            locationData = shelterDoc.data();
            
            // Récupérer les informations de l'inspecteur
            const inspectorDoc = await db.collection('inspectors').doc(inspectionData.inspector_id).get();
            inspectorData = inspectorDoc.data();
          }
        }
        
        if (!inspectionData) {
          throw new Error("Inspection non trouvée");
        }
        
        // Remplir la modal avec les détails
        fillModalWithInspectionDetails(inspectionData, locationData, inspectorData, type);
        
        // Afficher la modal
        modal.style.display = 'block';
      } catch (error) {
        console.error("Erreur lors du chargement des détails de l'inspection:", error);
        alert("Erreur lors du chargement des détails de l'inspection.");
      } finally {
        showLoading(false);
      }
    }

    // Remplir la modal avec les détails de l'inspection
    function fillModalWithInspectionDetails(inspection, location, inspector, type) {
      const modalContent = document.getElementById('modal-content');
      
      // Type d'emplacement
      const locationTypeText = type === 'trail' ? 'Sentier' : 'Abri';
      const locationName = location ? location.name : (type === 'trail' ? 'Sentier inconnu' : 'Abri inconnu');
      
      // Formater la date
      const date = inspection.date.toDate();
      const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}, ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
      
      // État
      let statusText = '';
      switch (inspection.condition) {
        case 'good':
          statusText = 'Bon';
          break;
        case 'warning':
          statusText = 'Attention';
          break;
        case 'critical':
          statusText = 'Critique';
          break;
        default:
          statusText = 'Non inspecté';
      }
      
      // Informations spécifiques au type
      let specificInfoHTML = '';
      if (type === 'trail' && location) {
        let difficultyText = '';
        switch (location.difficulty) {
          case 'easy':
            difficultyText = 'Facile';
            break;
          case 'medium':
            difficultyText = 'Intermédiaire';
            break;
          case 'hard':
            difficultyText = 'Difficile';
            break;
          default:
            difficultyText = 'Inconnue';
        }
        
        specificInfoHTML = `
          <li>
            <div class="detail-label">Longueur</div>
            <div class="detail-value">${location.length || '?'} km</div>
          </li>
          <li>
            <div class="detail-label">Difficulté</div>
            <div class="detail-value">${difficultyText}</div>
          </li>
        `;
      } else if (type === 'shelter' && location) {
        specificInfoHTML = `
          <li>
            <div class="detail-label">Altitude</div>
            <div class="detail-value">${location.altitude || '?'} m</div>
          </li>
        `;
        
        if (inspection.cleanliness) {
          let cleanlinessText = '';
          switch (inspection.cleanliness) {
            case 'good':
              cleanlinessText = 'Propre';
              break;
            case 'warning':
              cleanlinessText = 'Moyen';
              break;
            case 'critical':
              cleanlinessText = 'Sale';
              break;
          }
          
          specificInfoHTML += `
            <li>
              <div class="detail-label">Propreté</div>
              <div class="detail-value">${cleanlinessText}</div>
            </li>
          `;
        }
        
        if (inspection.accessibility) {
          let accessibilityText = '';
          switch (inspection.accessibility) {
            case 'good':
              accessibilityText = 'Dégagé';
              break;
            case 'warning':
              accessibilityText = 'Partiellement obstrué';
              break;
            case 'critical':
              accessibilityText = 'Bloqué';
              break;
          }
          
          specificInfoHTML += `
            <li>
              <div class="detail-label">Accessibilité</div>
              <div class="detail-value">${accessibilityText}</div>
            </li>
          `;
        }
      }
      
      // Problèmes signalés
      let issuesHTML = '';
      if (inspection.issues && inspection.issues.length > 0) {
        inspection.issues.forEach(issue => {
          issuesHTML += `
            <div class="issue-item">
              <p><strong>${issue}</strong></p>
            </div>
          `;
        });
      } else {
        issuesHTML = '<p>Aucun problème signalé</p>';
      }
      
      // Photos
      let photosHTML = '';
      if (inspection.photos && inspection.photos.length > 0) {
        photosHTML = '<div class="photo-gallery">';
        inspection.photos.forEach(photoUrl => {
          photosHTML += `
            <div class="gallery-image">
              <img src="${photoUrl}" alt="Photo d'inspection" onclick="window.open('${photoUrl}', '_blank')">
            </div>
          `;
        });
        photosHTML += '</div>';
      } else {
        photosHTML = '<p>Aucune photo disponible</p>';
      }
      
      // Commentaires
      const comments = inspection.comments || 'Aucun commentaire';
      
      // Construction du HTML de la modal
      modalContent.innerHTML = `
		  <div class="inspection-details">
			<div class="detail-box">
			  <h3 class="detail-title" style="color: #1f2937;">Informations générales</h3>
			  <ul class="detail-list">
				<li>
				  <div class="detail-label" style="color: #4b5563;">Type</div>
				  <div class="detail-value" style="color: #1f2937;"><span class="type-badge ${type === 'trail' ? 'type-trail' : 'type-shelter'}">${locationTypeText}</span> ${locationName}</div>
				</li>
				<li>
				  <div class="detail-label" style="color: #4b5563;">Date et heure</div>
				  <div class="detail-value" style="color: #1f2937;">${formattedDate}</div>
				</li>
				<li>
				  <div class="detail-label" style="color: #4b5563;">Inspecteur</div>
				  <div class="detail-value" style="color: #1f2937;">${inspector ? inspector.name : 'Inspecteur inconnu'}</div>
				</li>
				<li>
				  <div class="detail-label" style="color: #4b5563;">État général</div>
				  <div class="detail-value" style="color: #1f2937;"><span class="status-badge status-${inspection.condition}">${statusText}</span></div>
				</li>
			  </ul>
			</div>
			
			<div class="detail-box">
			  <h3 class="detail-title" style="color: #1f2937;">Problèmes signalés</h3>
			  <div class="issues-list" style="color: #1f2937;">
				${issuesHTML}
			  </div>
			</div>
			
			<div class="detail-box">
			  <h3 class="detail-title" style="color: #1f2937;">Caractéristiques</h3>
			  <ul class="detail-list" style="color: #1f2937;">
				${specificInfoHTML}
			  </ul>
			</div>
		  </div>
		  
		  <div class="detail-box">
			<h3 class="detail-title" style="color: #1f2937;">Commentaires</h3>
			<p style="padding: 0.5rem 0; color: #1f2937;">${comments}</p>
		  </div>
		  
		  <h3 class="detail-title" style="margin: 1.5rem 0 0.75rem; color: #1f2937;">Photos</h3>
		  ${photosHTML}
		`;
    }

    // Configurer l'exportation
    function setupExport() {
      // Exportation en PDF
      document.getElementById('export-pdf').addEventListener('click', function(e) {
        e.preventDefault();
        exportToPDF();
      });
      
      // Exportation en CSV
      document.getElementById('export-csv').addEventListener('click', function(e) {
        e.preventDefault();
        exportToCSV();
      });
      
      // Exportation en Excel
      document.getElementById('export-excel').addEventListener('click', function(e) {
        e.preventDefault();
        exportToExcel();
      });
    }

    // Exporter les données en PDF
    function exportToPDF() {
      alert('Fonctionnalité d\'exportation PDF en cours de développement.');
      // Dans une implémentation réelle, utilisez une bibliothèque comme jsPDF
    }

    // Exporter les données en CSV
    function exportToCSV() {
      try {
        // En-tête CSV
        let csvContent = "Date,Type,Sentier/Abri,Inspecteur,État,Problèmes,Commentaires\n";
        
        // Ajouter chaque inspection
        filteredInspections.forEach(inspection => {
          // Formater la date
          const date = inspection.date;
          const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
          
          // Type
          const typeText = inspection.type === 'trail' ? 'Sentier' : 'Abri';
          
          // État
          let statusText = '';
          switch (inspection.condition) {
            case 'good':
              statusText = 'Bon';
              break;
            case 'warning':
              statusText = 'Attention';
              break;
            case 'critical':
              statusText = 'Critique';
              break;
            default:
              statusText = 'Non inspecté';
          }
          
          // Problèmes (échapper les virgules)
          const issues = inspection.issues.length > 0 
            ? `"${inspection.issues.join('; ').replace(/"/g, '""')}"`
            : '';
          
          // Commentaires (échapper les virgules)
          const comments = inspection.comments 
            ? `"${inspection.comments.replace(/"/g, '""')}"`
            : '';
          
          // Ajouter la ligne
          csvContent += `${formattedDate},${typeText},${inspection.location},${inspection.inspector},${statusText},${issues},${comments}\n`;
        });
        
        // Créer un lien pour télécharger le fichier
        const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + csvContent);
        const link = document.createElement('a');
        link.setAttribute('href', encodedUri);
        link.setAttribute('download', `inspections_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        
        // Cliquer sur le lien pour télécharger
        link.click();
        
        // Supprimer le lien
        document.body.removeChild(link);
      } catch (error) {
        console.error("Erreur lors de l'exportation CSV:", error);
        alert("Erreur lors de l'exportation en CSV.");
      }
    }

    // Exporter les données en Excel
    function exportToExcel() {
      alert('Fonctionnalité d\'exportation Excel en cours de développement.');
      // Dans une implémentation réelle, utilisez une bibliothèque comme SheetJS (xlsx)
    }

    // Afficher/masquer l'indicateur de chargement
	function showLoading(show) {
	  const overlay = document.getElementById('loading-overlay');
	  if (overlay) {
		overlay.style.display = show ? 'flex' : 'none';
	  }
	}

    // Déclarer loadInspectionHistory comme une fonction globale pour qu'elle soit accessible depuis auth.js
    window.loadInspectionHistory = loadInspectionHistory;
  </script>
</body>
</html>
    }